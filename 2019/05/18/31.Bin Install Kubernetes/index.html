<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/32.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/16.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Kubernetes,Bin,">










<meta name="description" content="二进制安装k8s v1.14.2 环境准备123456789101112## 系统：7.6 内核3.10## k8s域名:tk8s.com## k8s集群：tk8s## apiserver：tk8s-api.tk8s.com192.168.48.101 master01.tk8s.com etcd01.tk8s.com master01 etcd01192.168.48.102 master02.">
<meta name="keywords" content="Kubernetes,Bin">
<meta property="og:type" content="article">
<meta property="og:title" content="31.Bin Install Kubernetes">
<meta property="og:url" content="http://yoursite.com/2019/05/18/31.Bin Install Kubernetes/index.html">
<meta property="og:site_name" content="Kubernetes">
<meta property="og:description" content="二进制安装k8s v1.14.2 环境准备123456789101112## 系统：7.6 内核3.10## k8s域名:tk8s.com## k8s集群：tk8s## apiserver：tk8s-api.tk8s.com192.168.48.101 master01.tk8s.com etcd01.tk8s.com master01 etcd01192.168.48.102 master02.">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://kairen.github.io/images/kube/kubernetes-aa-ha.png">
<meta property="og:updated_time" content="2019-05-20T11:40:17.005Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="31.Bin Install Kubernetes">
<meta name="twitter:description" content="二进制安装k8s v1.14.2 环境准备123456789101112## 系统：7.6 内核3.10## k8s域名:tk8s.com## k8s集群：tk8s## apiserver：tk8s-api.tk8s.com192.168.48.101 master01.tk8s.com etcd01.tk8s.com master01 etcd01192.168.48.102 master02.">
<meta name="twitter:image" content="https://kairen.github.io/images/kube/kubernetes-aa-ha.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/05/18/31.Bin Install Kubernetes/">





  <title>31.Bin Install Kubernetes | Kubernetes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kubernetes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/18/31.Bin Install Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="TangWei">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/me.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kubernetes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">31.Bin Install Kubernetes</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-18T19:00:41+08:00">
                2019-05-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/Bin/" itemprop="url" rel="index">
                    <span itemprop="name">Bin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="二进制安装k8s-v1-14-2"><a href="#二进制安装k8s-v1-14-2" class="headerlink" title="二进制安装k8s v1.14.2"></a>二进制安装k8s v1.14.2</h1><p><img src="https://kairen.github.io/images/kube/kubernetes-aa-ha.png" alt></p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">## 系统：7.6 内核3.10</span><br><span class="line">## k8s域名:tk8s.com</span><br><span class="line">## k8s集群：tk8s</span><br><span class="line">## apiserver：tk8s-api.tk8s.com</span><br><span class="line">192.168.48.101 master01.tk8s.com etcd01.tk8s.com master01 etcd01</span><br><span class="line">192.168.48.102 master02.tk8s.com etcd02.tk8s.com master02 etcd02</span><br><span class="line">192.168.48.103 master03.tk8s.com etcd03.tk8s.com master03 etcd03</span><br><span class="line">192.168.48.201 node01.tk8s.com   node01</span><br><span class="line">192.168.48.202 node02.tk8s.com   node02</span><br><span class="line">192.168.48.203 node03.tk8s.com   node03</span><br><span class="line">## keepalived的vip</span><br><span class="line">192.168.48.66  vip  tk8s-api.tk8s.com</span><br></pre></td></tr></table></figure>
<h2 id="所有节点执行"><a href="#所有节点执行" class="headerlink" title="所有节点执行"></a>所有节点执行</h2><h3 id="所有节点关闭selinux和firewalld"><a href="#所有节点关闭selinux和firewalld" class="headerlink" title="所有节点关闭selinux和firewalld"></a>所有节点关闭selinux和firewalld</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable firewalld.service</span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &apos;s/SELINUX=enforcing/SELINUX=disabled/&apos; /etc/selinux/config</span><br></pre></td></tr></table></figure>
<h3 id="所有节点升级内核"><a href="#所有节点升级内核" class="headerlink" title="所有节点升级内核"></a>所有节点升级内核</h3><h4 id="从3-10-升级到-4-4-180"><a href="#从3-10-升级到-4-4-180" class="headerlink" title="从3.10 升级到 4.4.180"></a>从3.10 升级到 4.4.180</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">##导入内核的yum源</span><br><span class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br><span class="line"></span><br><span class="line">## 查看版本 kernel-lt指长期稳定版 kernel-ml指最新版</span><br><span class="line">[root@master01 ~]# yum --disablerepo=&quot;*&quot; --enablerepo=&quot;elrepo-kernel&quot; list available</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * elrepo-kernel: mirrors.tuna.tsinghua.edu.cn</span><br><span class="line">Available Packages</span><br><span class="line">kernel-lt-devel.x86_64                                            4.4.180-1.el7.elrepo                                 elrepo-kernel</span><br><span class="line">kernel-lt-doc.noarch                                              4.4.180-1.el7.elrepo                                 elrepo-kernel</span><br><span class="line">kernel-lt-headers.x86_64                                          4.4.180-1.el7.elrepo                                 elrepo-kernel</span><br><span class="line">kernel-lt-tools.x86_64                                            4.4.180-1.el7.elrepo                                 elrepo-kernel</span><br><span class="line">kernel-lt-tools-libs.x86_64                                       4.4.180-1.el7.elrepo                                 elrepo-kernel</span><br><span class="line">kernel-lt-tools-libs-devel.x86_64                                 4.4.180-1.el7.elrepo                                 elrepo-kernel</span><br><span class="line">kernel-ml.x86_64                                                  5.1.3-1.el7.elrepo                                   elrepo-kernel</span><br><span class="line">kernel-ml-devel.x86_64                                            5.1.3-1.el7.elrepo                                   elrepo-kernel</span><br><span class="line">kernel-ml-doc.noarch                                              5.1.3-1.el7.elrepo                                   elrepo-kernel</span><br><span class="line">kernel-ml-headers.x86_64                                          5.1.3-1.el7.elrepo                                   elrepo-kernel</span><br><span class="line">kernel-ml-tools.x86_64                                            5.1.3-1.el7.elrepo                                   elrepo-kernel</span><br><span class="line">kernel-ml-tools-libs.x86_64                                       5.1.3-1.el7.elrepo                                   elrepo-kernel</span><br><span class="line">kernel-ml-tools-libs-devel.x86_64                                 5.1.3-1.el7.elrepo                                   elrepo-kernel</span><br><span class="line">perf.x86_64                                                       5.1.3-1.el7.elrepo                                   elrepo-kernel</span><br><span class="line">python-perf.x86_64                                                5.1.3-1.el7.elrepo                                   elrepo-kernel</span><br><span class="line">## 安装kernel-lt</span><br><span class="line">yum -y update</span><br><span class="line">yum --enablerepo=elrepo-kernel install kernel-lt -y</span><br></pre></td></tr></table></figure>
<h4 id="设置grub2"><a href="#设置grub2" class="headerlink" title="设置grub2"></a>设置grub2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">## 查看系统上的所有可用内核</span><br><span class="line">awk -F\&apos; &apos;$1==&quot;menuentry &quot; &#123;print i++ &quot; : &quot; $2&#125;&apos; /etc/grub2.cfg</span><br><span class="line"></span><br><span class="line">##设置新的内核为grub2的默认版本</span><br><span class="line">[root@master01 ~]# vim /etc/default/grub </span><br><span class="line">GRUB_TIMEOUT=5</span><br><span class="line">GRUB_DISTRIBUTOR=&quot;$(sed &apos;s, release .*$,,g&apos; /etc/system-release)&quot;</span><br><span class="line">GRUB_DEFAULT=0</span><br><span class="line">GRUB_DISABLE_SUBMENU=true</span><br><span class="line">GRUB_TERMINAL_OUTPUT=&quot;console&quot;</span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;rd.lvm.lv=centos/root rhgb quiet&quot;</span><br><span class="line">GRUB_DISABLE_RECOVERY=&quot;true&quot;</span><br><span class="line">## 生成 grub 配置文件并重启</span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line">## 重启</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h3 id="所有节点关闭swap"><a href="#所有节点关闭swap" class="headerlink" title="所有节点关闭swap"></a>所有节点关闭swap</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF</span><br><span class="line">vm.swappiness = 0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">swapoff -a</span><br><span class="line"></span><br><span class="line">sed -ri &apos;s/.*swap.*/#&amp;/&apos; /etc/fstab</span><br></pre></td></tr></table></figure>
<h3 id="所有节点开启内核转发参数"><a href="#所有节点开启内核转发参数" class="headerlink" title="所有节点开启内核转发参数"></a>所有节点开启内核转发参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<h3 id="所有节点开启IPVS"><a href="#所有节点开启IPVS" class="headerlink" title="所有节点开启IPVS"></a>所有节点开启IPVS</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ipvsadm  ipset</span><br><span class="line"></span><br><span class="line"># 临时生效</span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line"># 永久生效</span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cd /etc/sysconfig/modules/</span><br><span class="line">cat ipvs.modules </span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line">chmod 755 ipvs.modules</span><br></pre></td></tr></table></figure>
<h3 id="所有节点安装docker"><a href="#所有节点安装docker" class="headerlink" title="所有节点安装docker"></a>所有节点安装docker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/yum.repos.d/ </span><br><span class="line">wget https://mirrors.aliyun.com/dockerce/linux/centos/docker-ce.repo</span><br><span class="line">yum -y install docker-ce</span><br></pre></td></tr></table></figure>
<h4 id="启动docker"><a href="#启动docker" class="headerlink" title="启动docker"></a>启动docker</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker.service</span><br></pre></td></tr></table></figure>
<h4 id="获取pause-3-1"><a href="#获取pause-3-1" class="headerlink" title="获取pause:3.1"></a>获取pause:3.1</h4><p>特殊原因，添加代理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/docker.service</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Environment=&quot;HTTPS_PROXY=http://192.168.50.66:9666&quot;</span><br><span class="line">Environment=&quot;NO_PROXY=127.0.0.0/8&quot;</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker pull k8s.gcr.io/pause:3.1</span><br><span class="line">3.1: Pulling from pause</span><br><span class="line">67ddbfb20a22: Pull complete </span><br><span class="line">Digest: sha256:f78411e19d84a252e53bff71a4407a5686c46983a2c2eeed83929b888179acea</span><br><span class="line">Status: Downloaded newer image for k8s.gcr.io/pause:3.1</span><br></pre></td></tr></table></figure>
<h3 id="所有节点安装CNI"><a href="#所有节点安装CNI" class="headerlink" title="所有节点安装CNI"></a>所有节点安装CNI</h3><p>下载地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/containernetworking/plugins/releases</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/containernetworking/plugins/releases/download/v0.8.0/cni-plugins-linux-amd64-v0.8.0.tgz</span><br><span class="line"></span><br><span class="line">mkdir -p /opt/cni/bin</span><br><span class="line">tar -xf cni-plugins-linux-amd64-v0.8.0.tgz  -C /opt/cni/bin/</span><br></pre></td></tr></table></figure>
<h2 id="etcd安装"><a href="#etcd安装" class="headerlink" title="etcd安装"></a>etcd安装</h2><h3 id="etcd节点"><a href="#etcd节点" class="headerlink" title="etcd节点"></a>etcd节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.48.101 master01.tk8s.com etcd01.tk8s.com master01 etcd01</span><br><span class="line">192.168.48.102 master02.tk8s.com etcd02.tk8s.com master02 etcd02</span><br><span class="line">192.168.48.103 master03.tk8s.com etcd03.tk8s.com master03 etcd03</span><br></pre></td></tr></table></figure>
<h3 id="etcd所有节点安装etcd"><a href="#etcd所有节点安装etcd" class="headerlink" title="etcd所有节点安装etcd"></a>etcd所有节点安装etcd</h3><p>版本是etcd-3.3.11-2.el7.centos.x86_64</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# yum -y install etcd</span><br><span class="line"></span><br><span class="line">[root@master02 ~]# yum -y install etcd</span><br><span class="line"></span><br><span class="line">[root@master03 ~]# yum -y install etcd</span><br></pre></td></tr></table></figure>
<h3 id="准备证书脚本"><a href="#准备证书脚本" class="headerlink" title="准备证书脚本"></a>准备证书脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# mkdir cert</span><br><span class="line">[root@master01 ~]# ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 2 root root 94 May 18 17:18 cert</span><br><span class="line">[root@master01 ~]# cd cert/</span><br><span class="line">[root@master01 cert]# ll</span><br><span class="line">total 28</span><br><span class="line">-rw-r--r-- 1 root root 2858 Oct 31  2018 etcd-certs-gen.sh</span><br><span class="line">-rw-r--r-- 1 root root  944 Oct 31  2018 gencerts.sh</span><br><span class="line">-rw-r--r-- 1 root root 9638 Oct 31  2018 k8s-certs-gen.sh</span><br><span class="line">-rw-r--r-- 1 root root 4339 Oct 31  2018 openssl.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">cat openssl.conf</span><br><span class="line"># environment variable values</span><br><span class="line">BASE_DOMAIN=</span><br><span class="line">CLUSTER_NAME=</span><br><span class="line">CERT_DIR=</span><br><span class="line">APISERVER_CLUSTER_IP=</span><br><span class="line">MASTER_NAME=</span><br><span class="line"></span><br><span class="line">[ ca ]</span><br><span class="line"># `man ca`</span><br><span class="line">default_ca = CA_default</span><br><span class="line"></span><br><span class="line">[ CA_default ]</span><br><span class="line"># Directory and file locations.</span><br><span class="line">dir               = $&#123;ENV::CERT_DIR&#125;</span><br><span class="line">certs             = $dir</span><br><span class="line">crl_dir           = $dir/crl</span><br><span class="line">new_certs_dir     = $dir</span><br><span class="line">database          = $dir/index.txt</span><br><span class="line">serial            = $dir/serial</span><br><span class="line"># certificate revocation lists.</span><br><span class="line">crlnumber         = $dir/crlnumber</span><br><span class="line">crl               = $dir/crl/intermediate-ca.crl</span><br><span class="line">crl_extensions    = crl_ext</span><br><span class="line">default_crl_days  = 30</span><br><span class="line">default_md        = sha256</span><br><span class="line"></span><br><span class="line">name_opt          = ca_default</span><br><span class="line">cert_opt          = ca_default</span><br><span class="line">default_days      = 3750</span><br><span class="line">preserve          = no</span><br><span class="line">policy            = policy_loose</span><br><span class="line"></span><br><span class="line">[ policy_loose ]</span><br><span class="line"># Allow the CA to sign a range of certificates.</span><br><span class="line">countryName             = optional</span><br><span class="line">stateOrProvinceName     = optional</span><br><span class="line">localityName            = optional</span><br><span class="line">organizationName        = optional</span><br><span class="line">organizationalUnitName  = optional</span><br><span class="line">commonName              = supplied</span><br><span class="line">emailAddress            = optional</span><br><span class="line"></span><br><span class="line">[ req ]</span><br><span class="line"># `man req`</span><br><span class="line">default_bits        = 4096</span><br><span class="line">distinguished_name  = req_distinguished_name</span><br><span class="line">string_mask         = utf8only</span><br><span class="line">default_md          = sha256</span><br><span class="line"></span><br><span class="line">[ req_distinguished_name ]</span><br><span class="line">countryName                    = Country Name (2 letter code)</span><br><span class="line">stateOrProvinceName            = State or Province Name</span><br><span class="line">localityName                   = Locality Name</span><br><span class="line">0.organizationName             = Organization Name</span><br><span class="line">organizationalUnitName         = Organizational Unit Name</span><br><span class="line">commonName                     = Common Name</span><br><span class="line"></span><br><span class="line"># Certificate extensions (`man x509v3_config`)</span><br><span class="line"></span><br><span class="line">[ v3_ca ]</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">authorityKeyIdentifier = keyid:always,issuer</span><br><span class="line">basicConstraints = critical, CA:true, pathlen:0</span><br><span class="line">keyUsage = critical, digitalSignature, cRLSign, keyCertSign</span><br><span class="line"></span><br><span class="line">[ client_cert ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">nsCertType = client</span><br><span class="line">nsComment = &quot;OpenSSL Generated Client Certificate&quot;</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">keyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line"></span><br><span class="line">[ server_cert ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">nsCertType = server</span><br><span class="line">nsComment = &quot;OpenSSL Generated Server Certificate&quot;</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">authorityKeyIdentifier = keyid,issuer:always</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line"></span><br><span class="line">[ identity_server_cert ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">nsCertType = server</span><br><span class="line">nsComment = &quot;OpenSSL Generated Server Certificate&quot;</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">authorityKeyIdentifier = keyid,issuer:always</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">subjectAltName = DNS.1:tectonic-identity-api.tectonic-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">[ etcd_server_cert ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">nsCertType = server</span><br><span class="line">nsComment = &quot;OpenSSL Generated Server Certificate&quot;</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">authorityKeyIdentifier = keyid,issuer:always</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">subjectAltName = DNS.1:*.$&#123;ENV::BASE_DOMAIN&#125;</span><br><span class="line"></span><br><span class="line">[ etcd_peer_cert ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">nsCertType = server</span><br><span class="line">nsComment = &quot;OpenSSL Generated Server Certificate&quot;</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">authorityKeyIdentifier = keyid,issuer:always</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth, clientAuth</span><br><span class="line">subjectAltName = DNS.1:*.$&#123;ENV::BASE_DOMAIN&#125;</span><br><span class="line"></span><br><span class="line">[ apiserver_cert ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">nsCertType = server</span><br><span class="line">nsComment = &quot;OpenSSL Generated Server Certificate&quot;</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">authorityKeyIdentifier = keyid,issuer:always</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth, clientAuth</span><br><span class="line">subjectAltName = @apiserver_names</span><br><span class="line"></span><br><span class="line">[ master_component_client_cert ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">nsCertType = client</span><br><span class="line">nsComment = &quot;OpenSSL Generated Client Certificate&quot;</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">keyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">subjectAltName = @master_names</span><br><span class="line"></span><br><span class="line">[apiserver_names]</span><br><span class="line">DNS.1 = $&#123;ENV::CLUSTER_NAME&#125;-api.$&#123;ENV::BASE_DOMAIN&#125;</span><br><span class="line">DNS.2 = $&#123;ENV::MASTER_NAME&#125;.$&#123;ENV::BASE_DOMAIN&#125;</span><br><span class="line">DNS.3 = kubernetes</span><br><span class="line">DNS.4 = kubernetes.default</span><br><span class="line">DNS.5 = kubernetes.default.svc</span><br><span class="line">DNS.6 = kubernetes.default.svc.cluster.local</span><br><span class="line">IP.1 = $&#123;ENV::APISERVER_CLUSTER_IP&#125;</span><br><span class="line"></span><br><span class="line">[ master_names ]</span><br><span class="line">DNS.1 = $&#123;ENV::MASTER_NAME&#125;.$&#123;ENV::BASE_DOMAIN&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">cat gencerts.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash -e</span><br><span class="line">#</span><br><span class="line">function usage() &#123;</span><br><span class="line">    &gt;&amp;2 cat &lt;&lt; EOF</span><br><span class="line">Usage: ./gencerts.sh etcd|k8s</span><br><span class="line">EOF</span><br><span class="line">exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ -z &quot;$1&quot; ]; then </span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ &quot;$1&quot; != &quot;etcd&quot; &amp;&amp; &quot;$1&quot; != &quot;k8s&quot; ]]; then</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">read -p &quot;Enter Domain Name [ilinux.io]: &quot; BASE_DOMAIN</span><br><span class="line">BASE_DOMAIN=$&#123;BASE_DOMAIN:-ilinux.io&#125;</span><br><span class="line">export BASE_DOMAIN</span><br><span class="line"></span><br><span class="line">if [ &quot;$1&quot; == &apos;k8s&apos; ]; then</span><br><span class="line">    read -p &quot;Enter Kubernetes Cluster Name [kubernetes]: &quot; CLUSTER_NAME</span><br><span class="line">    echo -n -e &quot;Enter the IP Address in default namespace \n  of the Kubernetes API Server[10.96.0.1]: &quot;</span><br><span class="line">    read  APISERVER_CLUSTER_IP</span><br><span class="line">    read -p &quot;Enter Master servers name[master01 master02 master03]: &quot; MASTERS</span><br><span class="line"></span><br><span class="line">    CLUSTER_NAME=$&#123;CLUSTER_NAME:-kubernetes&#125;</span><br><span class="line">    APISERVER_CLUSTER_IP=$&#123;APISERVER_CLUSTER_IP:-10.96.0.1&#125;</span><br><span class="line">    MASTERS=$&#123;MASTERS:-&quot;master01 master02 master03&quot;&#125;</span><br><span class="line"></span><br><span class="line">    export CLUSTER_NAME APISERVER_CLUSTER_IP MASTERS</span><br><span class="line"></span><br><span class="line">    bash ./k8s-certs-gen.sh kubernetes</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if [ &quot;$1&quot; == &apos;etcd&apos; ]; then</span><br><span class="line">    bash ./etcd-certs-gen.sh etcd</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">cat etcd-certs-gen.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash -e</span><br><span class="line"></span><br><span class="line">function usage() &#123;</span><br><span class="line">    &gt;&amp;2 cat &lt;&lt; EOF</span><br><span class="line">Usage: ./etcd-certs-gen.sh</span><br><span class="line"></span><br><span class="line">Set the following environment variables to run this script:</span><br><span class="line"></span><br><span class="line">    BASE_DOMAIN     Base domain name of the cluster. For example if your API</span><br><span class="line">                    server is running on &quot;my-cluster-k8s.example.com&quot;, the</span><br><span class="line">                    base domain is &quot;example.com&quot;</span><br><span class="line"></span><br><span class="line">    CA_CERT(optional)         Path to the pem encoded CA certificate of your cluster.</span><br><span class="line">    CA_KEY(optional)          Path to the pem encoded CA key of your cluster.</span><br><span class="line">EOF</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ -z $BASE_DOMAIN ]; then</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">export DIR=&quot;generated&quot;</span><br><span class="line">if [ $# -eq 1 ]; then</span><br><span class="line">    DIR=&quot;$1&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">export CERT_DIR=$DIR/pki</span><br><span class="line">mkdir -p $CERT_DIR</span><br><span class="line">PATCHES=$DIR/patches</span><br><span class="line">mkdir -p $PATCHES</span><br><span class="line"></span><br><span class="line"># Configure expected OpenSSL CA configs.</span><br><span class="line"></span><br><span class="line">touch $CERT_DIR/index</span><br><span class="line">touch $CERT_DIR/index.txt</span><br><span class="line">touch $CERT_DIR/index.txt.attr</span><br><span class="line">echo 1000 &gt; $CERT_DIR/serial</span><br><span class="line"># Sign multiple certs for the same CN</span><br><span class="line">echo &quot;unique_subject = no&quot; &gt; $CERT_DIR/index.txt.attr</span><br><span class="line"></span><br><span class="line">function openssl_req() &#123;</span><br><span class="line">    openssl genrsa -out $&#123;1&#125;/$&#123;2&#125;.key 2048</span><br><span class="line">    echo &quot;Generating $&#123;1&#125;/$&#123;2&#125;.csr&quot;</span><br><span class="line">    openssl req -config openssl.conf -new -sha256 \</span><br><span class="line">        -key $&#123;1&#125;/$&#123;2&#125;.key -out $&#123;1&#125;/$&#123;2&#125;.csr -subj &quot;$3&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function openssl_sign() &#123;</span><br><span class="line">    echo &quot;Generating $&#123;3&#125;/$&#123;4&#125;.crt&quot;</span><br><span class="line">    openssl ca -batch -config openssl.conf -extensions $5 -days 3650 -notext \</span><br><span class="line">        -md sha256 -in $&#123;3&#125;/$&#123;4&#125;.csr -out $&#123;3&#125;/$&#123;4&#125;.crt \</span><br><span class="line">        -cert $&#123;1&#125; -keyfile $&#123;2&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ -z &quot;$CA_KEY&quot; -o -z &quot;$CA_CERT&quot; ]; then</span><br><span class="line">    openssl genrsa -out $CERT_DIR/ca.key 4096</span><br><span class="line">    openssl req -config openssl.conf \</span><br><span class="line">        -new -x509 -days 3650 -sha256 \</span><br><span class="line">        -key $CERT_DIR/ca.key -extensions v3_ca \</span><br><span class="line">        -out $CERT_DIR/ca.crt -subj &quot;/CN=etcd-ca&quot;</span><br><span class="line">    export CA_KEY=&quot;$CERT_DIR/ca.key&quot;</span><br><span class="line">    export CA_CERT=&quot;$CERT_DIR/ca.crt&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">openssl_req $CERT_DIR peer &quot;/CN=etcd&quot;</span><br><span class="line">openssl_req $CERT_DIR server &quot;/CN=etcd&quot;</span><br><span class="line">openssl_req $CERT_DIR apiserver-etcd-client &quot;/CN=etcd&quot;</span><br><span class="line">openssl_req $CERT_DIR client &quot;/CN=etcd&quot;</span><br><span class="line">    </span><br><span class="line">openssl_sign $CERT_DIR/ca.crt $CERT_DIR/ca.key $CERT_DIR peer etcd_peer_cert</span><br><span class="line">openssl_sign $CERT_DIR/ca.crt $CERT_DIR/ca.key $CERT_DIR server etcd_server_cert</span><br><span class="line">openssl_sign $CERT_DIR/ca.crt $CERT_DIR/ca.key $CERT_DIR apiserver-etcd-client client_cert</span><br><span class="line">openssl_sign $CERT_DIR/ca.crt $CERT_DIR/ca.key $CERT_DIR client client_cert</span><br><span class="line"></span><br><span class="line"># Add debug information to directories</span><br><span class="line">#for CERT in $CERT_DIR/*.crt; do</span><br><span class="line">#    openssl x509 -in $CERT -noout -text &gt; &quot;$&#123;CERT%.crt&#125;.txt&quot;</span><br><span class="line">#done</span><br><span class="line"></span><br><span class="line">ETCD_PATCHES=$DIR/patches</span><br><span class="line">mkdir -p $ETCD_PATCHES</span><br><span class="line"></span><br><span class="line"># kubectl apply </span><br><span class="line">cat &gt; $ETCD_PATCHES/etcd-client-cert.patch &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-apiserver</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  etcd-client.crt: $( openssl base64 -A -in $&#123;CERT_DIR&#125;/client.crt )</span><br><span class="line">  etcd-client.key: $( openssl base64 -A -in $&#123;CERT_DIR&#125;/client.key )</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># Clean up openssl config</span><br><span class="line">rm $CERT_DIR/index*</span><br><span class="line">rm $CERT_DIR/100*</span><br><span class="line">rm $CERT_DIR/serial*</span><br><span class="line">rm $CERT_DIR/*.csr</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line">cat k8s-certs-gen.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash -e</span><br><span class="line"></span><br><span class="line">ETCD_CERTS_DIR=&quot;etcd&quot;</span><br><span class="line"></span><br><span class="line">function usage() &#123;</span><br><span class="line">    &gt;&amp;2 cat &lt;&lt; EOF</span><br><span class="line">Usage: ./k8s-certs-gen.sh</span><br><span class="line"></span><br><span class="line">Set the following environment variables to run this script:</span><br><span class="line"></span><br><span class="line">    BASE_DOMAIN     Base domain name of the cluster. For example if your API</span><br><span class="line">                    server is running on &quot;my-cluster-k8s.ilinux.io&quot;, the</span><br><span class="line">                    base domain is &quot;ilinux.io&quot;</span><br><span class="line"></span><br><span class="line">    CLUSTER_NAME    Name of the cluster. If your API server is running on the</span><br><span class="line">                    domain &quot;my-cluster-k8s.ilinux.io&quot;, the name of the cluster</span><br><span class="line">                    is &quot;my-cluster&quot;</span><br><span class="line"></span><br><span class="line">    APISERVER_CLUSTER_IP</span><br><span class="line">                    Cluster IP address of the &quot;kubernetes&quot; service in the</span><br><span class="line">                    &quot;default&quot; namespace.</span><br><span class="line"></span><br><span class="line">    CA_CERT         Path to the pem encoded CA certificate of your cluster.</span><br><span class="line">    CA_KEY          Path to the pem encoded CA key of your cluster.</span><br><span class="line"></span><br><span class="line">    MASTERS      Name list. If all of your master&apos;s name is </span><br><span class="line">                    &quot;master01.ilinux.io&quot;, &quot;master02.ilinux.io&quot; and &quot;master03.ilinux.io&quot;,</span><br><span class="line">		    the list value is &quot;master01 master02 master03&quot;. </span><br><span class="line">EOF</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ -z $BASE_DOMAIN ]; then</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line">if [ -z $CLUSTER_NAME ]; then</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line">if [ -z $APISERVER_CLUSTER_IP ]; then</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line">if [ -z &quot;$MASTERS&quot; ]; then</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">export DIR=&quot;generated&quot;</span><br><span class="line">if [ $# -eq 1 ]; then</span><br><span class="line">    DIR=&quot;$1&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">export CERT_DIR=$DIR/CA</span><br><span class="line">mkdir -p $CERT_DIR</span><br><span class="line"></span><br><span class="line">export CA_CERT=&quot;$CERT_DIR/ca.crt&quot;</span><br><span class="line">export CA_KEY=&quot;$CERT_DIR/ca.key&quot;</span><br><span class="line">if [ -f &quot;$CA_CERT&quot; -a -f &quot;$CA_KEY&quot; ]; then</span><br><span class="line">    echo &quot;Using the CA: $CA_CERT and $CA_KEY&quot;</span><br><span class="line">    read -p &quot;pause&quot; A</span><br><span class="line">else</span><br><span class="line">    echo &quot;Generating CA key and self signed cert.&quot; </span><br><span class="line">    openssl genrsa -out $CERT_DIR/ca.key 4096</span><br><span class="line">    openssl req -config openssl.conf \</span><br><span class="line">        -new -x509 -days 3650 -sha256 \</span><br><span class="line">        -key $CERT_DIR/ca.key -out $CERT_DIR/ca.crt \</span><br><span class="line">	-subj &quot;/CN=k8s-ca&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Configure expected OpenSSL CA configs.</span><br><span class="line">touch $CERT_DIR/index</span><br><span class="line">touch $CERT_DIR/index.txt</span><br><span class="line">touch $CERT_DIR/index.txt.attr</span><br><span class="line">echo 1000 &gt; $CERT_DIR/serial</span><br><span class="line"># Sign multiple certs for the same CN</span><br><span class="line">echo &quot;unique_subject = no&quot; &gt; $CERT_DIR/index.txt.attr</span><br><span class="line"></span><br><span class="line">function openssl_req() &#123;</span><br><span class="line">    openssl genrsa -out $&#123;1&#125;/$&#123;2&#125;.key 2048</span><br><span class="line">    echo &quot;Generating $&#123;1&#125;/$&#123;2&#125;.csr&quot;</span><br><span class="line">    openssl req -config openssl.conf -new -sha256 \</span><br><span class="line">        -key $&#123;1&#125;/$&#123;2&#125;.key -out $&#123;1&#125;/$&#123;2&#125;.csr -subj &quot;$3&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function openssl_sign() &#123;</span><br><span class="line">    echo &quot;Generating $&#123;3&#125;/$&#123;4&#125;.crt&quot;</span><br><span class="line">    openssl ca -batch -config openssl.conf -extensions $5 -days 3650 -notext \</span><br><span class="line">        -md sha256 -in $&#123;3&#125;/$&#123;4&#125;.csr -out $&#123;3&#125;/$&#123;4&#125;.crt \</span><br><span class="line">        -cert $&#123;1&#125; -keyfile $&#123;2&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># If supplied, generate a new etcd CA and associated certs.</span><br><span class="line">if [ -n $FRONT_PROXY_CA_CERT ]; then</span><br><span class="line">    front_proxy_dir=$&#123;DIR&#125;/front-proxy</span><br><span class="line">    if [ ! -d &quot;$front_proxy_dir&quot; ]; then</span><br><span class="line">	mkdir $front_proxy_dir</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    openssl genrsa -out $&#123;front_proxy_dir&#125;/front-proxy-ca.key 2048</span><br><span class="line">    openssl req -config openssl.conf \</span><br><span class="line">        -new -x509 -days 3650 -sha256 \</span><br><span class="line">        -key $&#123;front_proxy_dir&#125;/front-proxy-ca.key \</span><br><span class="line">        -out $&#123;front_proxy_dir&#125;/front-proxy-ca.crt -subj &quot;/CN=front-proxy-ca&quot;</span><br><span class="line">    </span><br><span class="line">    openssl_req $&#123;front_proxy_dir&#125; front-proxy-client &quot;/CN=front-proxy-client&quot;</span><br><span class="line">    </span><br><span class="line">    openssl_sign $&#123;front_proxy_dir&#125;/front-proxy-ca.crt $&#123;front_proxy_dir&#125;/front-proxy-ca.key $&#123;front_proxy_dir&#125; front-proxy-client client_cert</span><br><span class="line">    rm -f $&#123;front_proxy_dir&#125;/*.csr</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># BootStrap Token</span><br><span class="line">export BOOTSTRAP_TOKEN=&quot;$(head -c 6 /dev/urandom | md5sum | head -c 6).$(head -c 16 /dev/urandom | md5sum | head -c 16)&quot;</span><br><span class="line">echo &quot;$BOOTSTRAP_TOKEN,\&quot;system:bootstrapper\&quot;,10001,\&quot;system:bootstrappers\&quot;&quot; &gt; /tmp/token.csv</span><br><span class="line"></span><br><span class="line"># Generate and sihn CSRs for all components of masters</span><br><span class="line">for master in $MASTERS; do</span><br><span class="line">    master_dir=&quot;$&#123;DIR&#125;/$&#123;master&#125;&quot;</span><br><span class="line"></span><br><span class="line">    if [ ! -d &quot;$&#123;master_dir&#125;&quot; ]; then</span><br><span class="line">        mkdir -p $&#123;master_dir&#125;/&#123;auth,pki&#125;</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    export MASTER_NAME=$&#123;master&#125;</span><br><span class="line"></span><br><span class="line">    openssl_req &quot;$&#123;master_dir&#125;/pki&quot; apiserver &quot;/CN=kube-apiserver&quot;</span><br><span class="line">    openssl_req &quot;$&#123;master_dir&#125;/pki&quot; kube-controller-manager &quot;/CN=system:kube-controller-manager&quot;</span><br><span class="line">    openssl_req &quot;$&#123;master_dir&#125;/pki&quot; kube-scheduler &quot;/CN=system:kube-scheduler&quot;</span><br><span class="line">    openssl_req &quot;$&#123;master_dir&#125;/pki&quot; apiserver-kubelet-client &quot;/CN=kube-apiserver-kubelet-client/O=system:masters&quot;</span><br><span class="line"></span><br><span class="line">    openssl_sign $CA_CERT $CA_KEY &quot;$&#123;master_dir&#125;/pki&quot; apiserver apiserver_cert</span><br><span class="line">    openssl_sign $CA_CERT $CA_KEY &quot;$&#123;master_dir&#125;/pki&quot; kube-controller-manager master_component_client_cert</span><br><span class="line">    openssl_sign $CA_CERT $CA_KEY &quot;$&#123;master_dir&#125;/pki&quot; kube-scheduler master_component_client_cert</span><br><span class="line">    openssl_sign $CA_CERT $CA_KEY &quot;$&#123;master_dir&#125;/pki&quot; apiserver-kubelet-client client_cert</span><br><span class="line">    rm -f $&#123;master_dir&#125;/pki/*.csr</span><br><span class="line"></span><br><span class="line">    # Copy CA key and cert file to $&#123;master_dir&#125;</span><br><span class="line">    cp $CA_CERT $CA_KEY $&#123;master_dir&#125;/pki/</span><br><span class="line"></span><br><span class="line">    # Copy front-proxy CA key and cert file to $&#123;master_dir&#125;</span><br><span class="line">    cp $front_proxy_dir/front-proxy* $&#123;master_dir&#125;/pki/</span><br><span class="line"></span><br><span class="line">    # echo &quot;Generating the ServiceAccount key for apiserver&quot;</span><br><span class="line">    openssl ecparam -name secp521r1 -genkey -noout -out $&#123;master_dir&#125;/pki/sa.key</span><br><span class="line">    openssl ec -in $&#123;master_dir&#125;/pki/sa.key -outform PEM -pubout -out $&#123;master_dir&#125;/pki/sa.pub</span><br><span class="line">   </span><br><span class="line">    # echo &quot;Copy token file&quot;</span><br><span class="line">    cp /tmp/token.csv $&#123;master_dir&#125;/</span><br><span class="line">    </span><br><span class="line">    if [ -d &quot;$ETCD_CERTS_DIR&quot; ]; then</span><br><span class="line">        # echo &quot;Copy etcd client key and certs&quot;</span><br><span class="line">	cp $ETCD_CERTS_DIR/pki/apiserver-etcd-client.&#123;key,crt&#125; $&#123;master_dir&#125;/pki/</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # echo &quot;Generating kubeconfig for kube-controller-manager&quot;</span><br><span class="line">    cat &gt; $&#123;master_dir&#125;/auth/controller-manager.conf &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Config</span><br><span class="line">clusters:</span><br><span class="line">- name: $&#123;CLUSTER_NAME&#125;</span><br><span class="line">  cluster:</span><br><span class="line">    server: https://$&#123;master&#125;.$&#123;BASE_DOMAIN&#125;:6443</span><br><span class="line">    certificate-authority-data: $( openssl base64 -A -in $CA_CERT ) </span><br><span class="line">users:</span><br><span class="line">- name: system:kube-controller-manager</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: $( openssl base64 -A -in $&#123;master_dir&#125;/pki/kube-controller-manager.crt ) </span><br><span class="line">    client-key-data: $( openssl base64 -A -in $&#123;master_dir&#125;/pki/kube-controller-manager.key ) </span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: $&#123;CLUSTER_NAME&#125;</span><br><span class="line">    user: system:kube-controller-manager</span><br><span class="line">  name: system:kube-controller-manager@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">current-context: system:kube-controller-manager@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # echo &quot;Generating kubeconfig for kube-scheduler&quot;</span><br><span class="line">    cat &gt; $&#123;master_dir&#125;/auth/scheduler.conf &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Config</span><br><span class="line">clusters:</span><br><span class="line">- name: $&#123;CLUSTER_NAME&#125;</span><br><span class="line">  cluster:</span><br><span class="line">    server: https://$&#123;master&#125;.$&#123;BASE_DOMAIN&#125;:6443</span><br><span class="line">    certificate-authority-data: $( openssl base64 -A -in $CA_CERT ) </span><br><span class="line">users:</span><br><span class="line">- name: system:kube-scheduler</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: $( openssl base64 -A -in $&#123;master_dir&#125;/pki/kube-scheduler.crt ) </span><br><span class="line">    client-key-data: $( openssl base64 -A -in $&#123;master_dir&#125;/pki/kube-scheduler.key ) </span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: $&#123;CLUSTER_NAME&#125;</span><br><span class="line">    user: system:kube-scheduler</span><br><span class="line">  name: system:kube-scheduler@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">current-context: system:kube-scheduler@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # echo &quot;Generating kubeconfig for Cluster Admin&quot;</span><br><span class="line">    cat &gt; $&#123;master_dir&#125;/auth/admin.conf &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Config</span><br><span class="line">clusters:</span><br><span class="line">- name: $&#123;CLUSTER_NAME&#125;</span><br><span class="line">  cluster:</span><br><span class="line">    server: https://$&#123;master&#125;.$&#123;BASE_DOMAIN&#125;:6443</span><br><span class="line">    certificate-authority-data: $( openssl base64 -A -in $CA_CERT ) </span><br><span class="line">users:</span><br><span class="line">- name: k8s-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: $( openssl base64 -A -in $&#123;master_dir&#125;/pki/apiserver-kubelet-client.crt ) </span><br><span class="line">    client-key-data: $( openssl base64 -A -in $&#123;master_dir&#125;/pki/apiserver-kubelet-client.key ) </span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: $&#123;CLUSTER_NAME&#125;</span><br><span class="line">    user: k8s-admin</span><br><span class="line">  name: k8s-admin@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">current-context: k8s-admin@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">EOF</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Generate key and cert for kubelet</span><br><span class="line">kubelet_dir=$&#123;DIR&#125;/kubelet</span><br><span class="line">mkdir -p $&#123;kubelet_dir&#125;/&#123;pki,auth&#125;</span><br><span class="line"></span><br><span class="line">openssl_req $&#123;kubelet_dir&#125;/pki kube-proxy &quot;/CN=system:kube-proxy&quot;</span><br><span class="line">openssl_sign $CA_CERT $CA_KEY $&#123;kubelet_dir&#125;/pki kube-proxy client_cert</span><br><span class="line">rm -f $&#123;kubelet_dir&#125;/pki/kube-proxy.csr</span><br><span class="line"></span><br><span class="line"># Copy CA Cert to Node</span><br><span class="line">cp $CA_CERT $&#123;kubelet_dir&#125;/pki/</span><br><span class="line"></span><br><span class="line">cat &gt; $&#123;kubelet_dir&#125;/auth/kube-proxy.conf &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Config</span><br><span class="line">clusters:</span><br><span class="line">- name: $&#123;CLUSTER_NAME&#125;</span><br><span class="line">  cluster:</span><br><span class="line">    server: https://$&#123;CLUSTER_NAME&#125;-api.$&#123;BASE_DOMAIN&#125;:6443</span><br><span class="line">    certificate-authority-data: $( openssl base64 -A -in $CA_CERT ) </span><br><span class="line">users:</span><br><span class="line">- name: system:kube-proxy</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: $( openssl base64 -A -in $&#123;kubelet_dir&#125;/pki/kube-proxy.crt ) </span><br><span class="line">    client-key-data: $( openssl base64 -A -in $&#123;kubelet_dir&#125;/pki/kube-proxy.key ) </span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: $&#123;CLUSTER_NAME&#125;</span><br><span class="line">    user: system:kube-proxy</span><br><span class="line">  name: system:kube-proxy@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">current-context: system:kube-proxy@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; $&#123;kubelet_dir&#125;/auth/bootstrap.conf &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Config</span><br><span class="line">clusters:</span><br><span class="line">- name: $&#123;CLUSTER_NAME&#125;</span><br><span class="line">  cluster:</span><br><span class="line">    server: https://$&#123;CLUSTER_NAME&#125;-api.$&#123;BASE_DOMAIN&#125;:6443</span><br><span class="line">    certificate-authority-data: $( openssl base64 -A -in $CA_CERT ) </span><br><span class="line">users:</span><br><span class="line">- name: system:bootstrapper</span><br><span class="line">  user:</span><br><span class="line">    token: $&#123;BOOTSTRAP_TOKEN&#125;</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: $&#123;CLUSTER_NAME&#125;</span><br><span class="line">    user: system:bootstrapper</span><br><span class="line">  name: system:bootstrapper@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">current-context: system:bootstrapper@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># Generate key and cert for ingress</span><br><span class="line">ingress_dir=$&#123;DIR&#125;/ingress</span><br><span class="line">mkdir -p $&#123;DIR&#125;/ingress/patches</span><br><span class="line"></span><br><span class="line">openssl_req $&#123;ingress_dir&#125; ingress-server &quot;/CN=$&#123;CLUSTER_NAME&#125;.$&#123;BASE_DOMAIN&#125;&quot;</span><br><span class="line">openssl_sign $CA_CERT $CA_KEY $&#123;ingress_dir&#125; ingress-server server_cert</span><br><span class="line">rm -f $&#123;ingress_dir&#125;/*.csr</span><br><span class="line"></span><br><span class="line"># Generate secret patches. We include the metadata here so</span><br><span class="line"># `kubectl patch -f ( file ) -p $( cat ( file ) )` works.</span><br><span class="line">cat &gt; $&#123;ingress_dir&#125;/patches/ingress-tls.patch &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-tls-secret</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  tls.crt: $( openssl base64 -A -in $&#123;ingress_dir&#125;/ingress-server.crt )</span><br><span class="line">  tls.key: $( openssl base64 -A -in $&#123;ingress_dir&#125;/ingress-server.key )</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># Clean up openssl config</span><br><span class="line">rm -f $CERT_DIR/index*</span><br><span class="line">rm -f $CERT_DIR/100*</span><br><span class="line">rm -f $CERT_DIR/serial*</span><br><span class="line">rm -f /tmp/token.csv</span><br></pre></td></tr></table></figure>
<h3 id="创建etcd的证书"><a href="#创建etcd的证书" class="headerlink" title="创建etcd的证书"></a>创建etcd的证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 cert]# bash gencerts.sh etcd</span><br><span class="line">Enter Domain Name [ilinux.io]: tk8s.com</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">[root@master01 cert]# tree etcd</span><br><span class="line">etcd</span><br><span class="line">├── patches</span><br><span class="line">│   └── etcd-client-cert.patch</span><br><span class="line">└── pki</span><br><span class="line">    ├── apiserver-etcd-client.crt</span><br><span class="line">    ├── apiserver-etcd-client.key</span><br><span class="line">    ├── ca.crt</span><br><span class="line">    ├── ca.key</span><br><span class="line">    ├── client.crt</span><br><span class="line">    ├── client.key</span><br><span class="line">    ├── peer.crt</span><br><span class="line">    ├── peer.key</span><br><span class="line">    ├── server.crt</span><br><span class="line">    └── server.key</span><br><span class="line"></span><br><span class="line">2 directories, 11 files</span><br></pre></td></tr></table></figure>
<h3 id="配置etcd01"><a href="#配置etcd01" class="headerlink" title="配置etcd01"></a>配置etcd01</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">## 将证书文件复制到/etc/etcd/</span><br><span class="line">[root@master01 cert]# ll</span><br><span class="line">total 28</span><br><span class="line">drwxr-xr-x 4 root root   32 May 18 17:52 etcd</span><br><span class="line">-rw-r--r-- 1 root root 2858 Oct 31  2018 etcd-certs-gen.sh</span><br><span class="line">-rw-r--r-- 1 root root  944 Oct 31  2018 gencerts.sh</span><br><span class="line">-rw-r--r-- 1 root root 9638 Oct 31  2018 k8s-certs-gen.sh</span><br><span class="line">drwxr-xr-x 9 root root  113 May 18 17:59 kubernetes</span><br><span class="line">-rw-r--r-- 1 root root 4340 May 18 17:50 openssl.conf</span><br><span class="line">[root@master01 cert]# pwd</span><br><span class="line">/root/cert</span><br><span class="line">[root@master01 cert]# cp -rp /root/cert/etcd/pki/ /etc/etcd/</span><br><span class="line"></span><br><span class="line">[root@master01 cert]# cd /etc/etcd</span><br><span class="line">[root@master01 etcd]# ll</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 1686 Feb 14 00:56 etcd.conf</span><br><span class="line">drwxr-xr-x 4 root root   32 May 18 17:52 pki</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 etcd]# cd /etc/etcd</span><br><span class="line">[root@master01 etcd]# vim etcd.conf</span><br><span class="line"></span><br><span class="line">#[Member]</span><br><span class="line">#ETCD_CORS=&quot;&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/k8s.etcd&quot;</span><br><span class="line">#ETCD_WAL_DIR=&quot;&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.48.101:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.48.101:2379&quot;</span><br><span class="line">#ETCD_MAX_SNAPSHOTS=&quot;5&quot;</span><br><span class="line">#ETCD_MAX_WALS=&quot;5&quot;</span><br><span class="line">ETCD_NAME=&quot;etcd01.tk8s.com&quot;</span><br><span class="line">ETCD_SNAPSHOT_COUNT=&quot;100000&quot;</span><br><span class="line">#ETCD_HEARTBEAT_INTERVAL=&quot;100&quot;</span><br><span class="line">#ETCD_ELECTION_TIMEOUT=&quot;1000&quot;</span><br><span class="line">#ETCD_QUOTA_BACKEND_BYTES=&quot;0&quot;</span><br><span class="line">#ETCD_MAX_REQUEST_BYTES=&quot;1572864&quot;</span><br><span class="line">#ETCD_GRPC_KEEPALIVE_MIN_TIME=&quot;5s&quot;</span><br><span class="line">#ETCD_GRPC_KEEPALIVE_INTERVAL=&quot;2h0m0s&quot;</span><br><span class="line">#ETCD_GRPC_KEEPALIVE_TIMEOUT=&quot;20s&quot;</span><br><span class="line">#</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://etcd01.tk8s.com:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://etcd01.tk8s.com:2379&quot;</span><br><span class="line">#ETCD_DISCOVERY=&quot;&quot;</span><br><span class="line">#ETCD_DISCOVERY_FALLBACK=&quot;proxy&quot;</span><br><span class="line">#ETCD_DISCOVERY_PROXY=&quot;&quot;</span><br><span class="line">#ETCD_DISCOVERY_SRV=&quot;&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd01.tk8s.com=https://etcd01.tk8s.com:2380,etcd02.tk8s.com=https://etcd02.tk8s.com:2380,etcd03.tk8s.com=https://etcd03.tk8s.com:2380&quot;</span><br><span class="line">#ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">#ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">#ETCD_STRICT_RECONFIG_CHECK=&quot;true&quot;</span><br><span class="line">#ETCD_ENABLE_V2=&quot;true&quot;</span><br><span class="line">#</span><br><span class="line">#[Proxy]</span><br><span class="line">#ETCD_PROXY=&quot;off&quot;</span><br><span class="line">#ETCD_PROXY_FAILURE_WAIT=&quot;5000&quot;</span><br><span class="line">#ETCD_PROXY_REFRESH_INTERVAL=&quot;30000&quot;</span><br><span class="line">#ETCD_PROXY_DIAL_TIMEOUT=&quot;1000&quot;</span><br><span class="line">#ETCD_PROXY_WRITE_TIMEOUT=&quot;5000&quot;</span><br><span class="line">#ETCD_PROXY_READ_TIMEOUT=&quot;0&quot;</span><br><span class="line">#</span><br><span class="line">#[Security]</span><br><span class="line">ETCD_CERT_FILE=&quot;/etc/etcd/pki/server.crt&quot;</span><br><span class="line">ETCD_KEY_FILE=&quot;/etc/etcd/pki/server.key&quot;</span><br><span class="line">ETCD_CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_TRUSTED_CA_FILE=&quot;/etc/etcd/pki/ca.crt&quot;</span><br><span class="line">ETCD_AUTO_TLS=&quot;false&quot;</span><br><span class="line">ETCD_PEER_CERT_FILE=&quot;/etc/etcd/pki/peer.crt&quot;</span><br><span class="line">ETCD_PEER_KEY_FILE=&quot;/etc/etcd/pki/peer.key&quot;</span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=&quot;/etc/etcd/pki/ca.crt&quot;</span><br><span class="line">ETCD_PEER_AUTO_TLS=&quot;false&quot;</span><br><span class="line">#</span><br><span class="line">#[Logging]</span><br><span class="line">#ETCD_DEBUG=&quot;false&quot;</span><br><span class="line">#ETCD_LOG_PACKAGE_LEVELS=&quot;&quot;</span><br><span class="line">#ETCD_LOG_OUTPUT=&quot;default&quot;</span><br><span class="line">#</span><br><span class="line">#[Unsafe]</span><br><span class="line">#ETCD_FORCE_NEW_CLUSTER=&quot;false&quot;</span><br><span class="line">#</span><br><span class="line">#[Version]</span><br><span class="line">#ETCD_VERSION=&quot;false&quot;</span><br><span class="line">#ETCD_AUTO_COMPACTION_RETENTION=&quot;0&quot;</span><br><span class="line">#</span><br><span class="line">#[Profiling]</span><br><span class="line">#ETCD_ENABLE_PPROF=&quot;false&quot;</span><br><span class="line">#ETCD_METRICS=&quot;basic&quot;</span><br><span class="line">#</span><br><span class="line">#[Auth]</span><br><span class="line">#ETCD_AUTH_TOKEN=&quot;simple&quot;</span><br></pre></td></tr></table></figure>
<h3 id="配置etcd02"><a href="#配置etcd02" class="headerlink" title="配置etcd02"></a>配置etcd02</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">## 将证书文件复制到/etc/etcd</span><br><span class="line">[root@master01 etcd]# cd /root/cert/</span><br><span class="line">[root@master01 cert]# ll</span><br><span class="line">total 28</span><br><span class="line">drwxr-xr-x 4 root root   32 May 18 17:52 etcd</span><br><span class="line">-rw-r--r-- 1 root root 2858 Oct 31  2018 etcd-certs-gen.sh</span><br><span class="line">-rw-r--r-- 1 root root  944 Oct 31  2018 gencerts.sh</span><br><span class="line">-rw-r--r-- 1 root root 9638 Oct 31  2018 k8s-certs-gen.sh</span><br><span class="line">drwxr-xr-x 9 root root  113 May 18 17:59 kubernetes</span><br><span class="line">-rw-r--r-- 1 root root 4340 May 18 17:50 openssl.conf</span><br><span class="line">[root@master01 cert]# scp -rp /root/cert/etcd/pki/  master02:/etc/etcd</span><br><span class="line">ca.key                                                                                                           100% 3243     4.9MB/s   00:00    </span><br><span class="line">ca.crt                                                                                                           100% 1814     1.8MB/s   00:00    </span><br><span class="line">peer.key                                                                                                         100% 1679     1.4MB/s   00:00    </span><br><span class="line">server.key                                                                                                       100% 1675     2.1MB/s   00:00    </span><br><span class="line">apiserver-etcd-client.key                                                                                        100% 1675     1.8MB/s   00:00    </span><br><span class="line">client.key                                                                                                       100% 1675     1.4MB/s   00:00    </span><br><span class="line">peer.crt                                                                                                         100% 1659     2.0MB/s   00:00    </span><br><span class="line">server.crt                                                                                                       100% 1647     1.9MB/s   00:00    </span><br><span class="line">apiserver-etcd-client.crt                                                                                        100% 1570     2.1MB/s   00:00    </span><br><span class="line">client.crt                                                                                                       100% 1570     2.3MB/s   00:00    </span><br><span class="line">etcd-client-cert.patch                                                                                           100% 4464     4.3MB/s   00:00</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[root@master02 ~]# cd /etc/etcd/</span><br><span class="line">[root@master02 etcd]# ll</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 1686 Feb 14 00:56 etcd.conf</span><br><span class="line">drwxr-xr-x 4 root root   32 May 18 17:52 pki</span><br><span class="line"></span><br><span class="line">[root@master02 etcd]# vim etcd.conf</span><br><span class="line"></span><br><span class="line">#[Member]</span><br><span class="line">#ETCD_CORS=&quot;&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/k8s.etcd&quot;</span><br><span class="line">#ETCD_WAL_DIR=&quot;&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.48.102:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.48.102:2379&quot;</span><br><span class="line">#ETCD_MAX_SNAPSHOTS=&quot;5&quot;</span><br><span class="line">#ETCD_MAX_WALS=&quot;5&quot;</span><br><span class="line">ETCD_NAME=&quot;etcd02.tk8s.com&quot;</span><br><span class="line">ETCD_SNAPSHOT_COUNT=&quot;100000&quot;</span><br><span class="line">#ETCD_HEARTBEAT_INTERVAL=&quot;100&quot;</span><br><span class="line">#ETCD_ELECTION_TIMEOUT=&quot;1000&quot;</span><br><span class="line">#ETCD_QUOTA_BACKEND_BYTES=&quot;0&quot;</span><br><span class="line">#ETCD_MAX_REQUEST_BYTES=&quot;1572864&quot;</span><br><span class="line">#ETCD_GRPC_KEEPALIVE_MIN_TIME=&quot;5s&quot;</span><br><span class="line">#ETCD_GRPC_KEEPALIVE_INTERVAL=&quot;2h0m0s&quot;</span><br><span class="line">#ETCD_GRPC_KEEPALIVE_TIMEOUT=&quot;20s&quot;</span><br><span class="line">#</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://etcd02.tk8s.com:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://etcd02.tk8s.com:2379&quot;</span><br><span class="line">#ETCD_DISCOVERY=&quot;&quot;</span><br><span class="line">#ETCD_DISCOVERY_FALLBACK=&quot;proxy&quot;</span><br><span class="line">#ETCD_DISCOVERY_PROXY=&quot;&quot;</span><br><span class="line">#ETCD_DISCOVERY_SRV=&quot;&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd01.tk8s.com=https://etcd01.tk8s.com:2380,etcd02.tk8s.com=https://etcd02.tk8s.com:2380,etcd03.tk8s.com=https://etcd03.tk8s.com:2380&quot;</span><br><span class="line">#ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">#ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">#ETCD_STRICT_RECONFIG_CHECK=&quot;true&quot;</span><br><span class="line">#ETCD_ENABLE_V2=&quot;true&quot;</span><br><span class="line">#</span><br><span class="line">#[Proxy]</span><br><span class="line">#ETCD_PROXY=&quot;off&quot;</span><br><span class="line">#ETCD_PROXY_FAILURE_WAIT=&quot;5000&quot;</span><br><span class="line">#ETCD_PROXY_REFRESH_INTERVAL=&quot;30000&quot;</span><br><span class="line">#ETCD_PROXY_DIAL_TIMEOUT=&quot;1000&quot;</span><br><span class="line">#ETCD_PROXY_WRITE_TIMEOUT=&quot;5000&quot;</span><br><span class="line">#ETCD_PROXY_READ_TIMEOUT=&quot;0&quot;</span><br><span class="line">#</span><br><span class="line">#[Security]</span><br><span class="line">ETCD_CERT_FILE=&quot;/etc/etcd/pki/server.crt&quot;</span><br><span class="line">ETCD_KEY_FILE=&quot;/etc/etcd/pki/server.key&quot;</span><br><span class="line">ETCD_CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_TRUSTED_CA_FILE=&quot;/etc/etcd/pki/ca.crt&quot;</span><br><span class="line">ETCD_AUTO_TLS=&quot;false&quot;</span><br><span class="line">ETCD_PEER_CERT_FILE=&quot;/etc/etcd/pki/peer.crt&quot;</span><br><span class="line">ETCD_PEER_KEY_FILE=&quot;/etc/etcd/pki/peer.key&quot;</span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=&quot;/etc/etcd/pki/ca.crt&quot;</span><br><span class="line">ETCD_PEER_AUTO_TLS=&quot;false&quot;</span><br><span class="line">#</span><br><span class="line">#[Logging]</span><br><span class="line">#ETCD_DEBUG=&quot;false&quot;</span><br><span class="line">#ETCD_LOG_PACKAGE_LEVELS=&quot;&quot;</span><br><span class="line">#ETCD_LOG_OUTPUT=&quot;default&quot;</span><br><span class="line">#</span><br><span class="line">#[Unsafe]</span><br><span class="line">#ETCD_FORCE_NEW_CLUSTER=&quot;false&quot;</span><br><span class="line">#</span><br><span class="line">#[Version]</span><br><span class="line">#ETCD_VERSION=&quot;false&quot;</span><br><span class="line">#ETCD_AUTO_COMPACTION_RETENTION=&quot;0&quot;</span><br><span class="line">#</span><br><span class="line">#[Profiling]</span><br><span class="line">#ETCD_ENABLE_PPROF=&quot;false&quot;</span><br><span class="line">#ETCD_METRICS=&quot;basic&quot;</span><br><span class="line">#</span><br><span class="line">#[Auth]</span><br><span class="line">#ETCD_AUTH_TOKEN=&quot;simple&quot;</span><br></pre></td></tr></table></figure>
<h3 id="配置etcd03"><a href="#配置etcd03" class="headerlink" title="配置etcd03"></a>配置etcd03</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">## 将证书文件复制到/etc/etcd/</span><br><span class="line">[root@master01 ~]# cd /root/cert/</span><br><span class="line">[root@master01 cert]# ll</span><br><span class="line">total 28</span><br><span class="line">drwxr-xr-x 4 root root   32 May 18 17:52 etcd</span><br><span class="line">-rw-r--r-- 1 root root 2858 Oct 31  2018 etcd-certs-gen.sh</span><br><span class="line">-rw-r--r-- 1 root root  944 Oct 31  2018 gencerts.sh</span><br><span class="line">-rw-r--r-- 1 root root 9638 Oct 31  2018 k8s-certs-gen.sh</span><br><span class="line">drwxr-xr-x 9 root root  113 May 18 17:59 kubernetes</span><br><span class="line">-rw-r--r-- 1 root root 4340 May 18 17:50 openssl.conf</span><br><span class="line">[root@master01 cert]# scp -rp /root/cert/etcd/pki/  master03:/etc/etcd</span><br><span class="line">ca.key                                                                                                           100% 3243     3.4MB/s   00:00    </span><br><span class="line">ca.crt                                                                                                           100% 1814     1.8MB/s   00:00    </span><br><span class="line">peer.key                                                                                                         100% 1679     2.0MB/s   00:00    </span><br><span class="line">server.key                                                                                                       100% 1675     2.4MB/s   00:00    </span><br><span class="line">apiserver-etcd-client.key                                                                                        100% 1675     2.0MB/s   00:00    </span><br><span class="line">client.key                                                                                                       100% 1675     2.2MB/s   00:00    </span><br><span class="line">peer.crt                                                                                                         100% 1659     1.5MB/s   00:00    </span><br><span class="line">server.crt                                                                                                       100% 1647   180.2KB/s   00:00    </span><br><span class="line">apiserver-etcd-client.crt                                                                                        100% 1570     1.6MB/s   00:00    </span><br><span class="line">client.crt                                                                                                       100% 1570   833.1KB/s   00:00    </span><br><span class="line">etcd-client-cert.patch                                                                                           100% 4464     6.2MB/s   00:00</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@master03 ~]# cd /etc/etcd/</span><br><span class="line">[root@master03 etcd]# ll</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 1686 Feb 14 00:56 etcd.conf</span><br><span class="line">drwxr-xr-x 4 root root   32 May 18 17:52 pki</span><br><span class="line">[root@master03 etcd]# vim etcd.conf </span><br><span class="line">#[Member]</span><br><span class="line">#ETCD_CORS=&quot;&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/k8s.etcd&quot;</span><br><span class="line">#ETCD_WAL_DIR=&quot;&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.48.103:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.48.103:2379&quot;</span><br><span class="line">#ETCD_MAX_SNAPSHOTS=&quot;5&quot;</span><br><span class="line">#ETCD_MAX_WALS=&quot;5&quot;</span><br><span class="line">ETCD_NAME=&quot;etcd03.tk8s.com&quot;</span><br><span class="line">ETCD_SNAPSHOT_COUNT=&quot;100000&quot;</span><br><span class="line">#ETCD_HEARTBEAT_INTERVAL=&quot;100&quot;</span><br><span class="line">#ETCD_ELECTION_TIMEOUT=&quot;1000&quot;</span><br><span class="line">#ETCD_QUOTA_BACKEND_BYTES=&quot;0&quot;</span><br><span class="line">#ETCD_MAX_REQUEST_BYTES=&quot;1572864&quot;</span><br><span class="line">#ETCD_GRPC_KEEPALIVE_MIN_TIME=&quot;5s&quot;</span><br><span class="line">#ETCD_GRPC_KEEPALIVE_INTERVAL=&quot;2h0m0s&quot;</span><br><span class="line">#ETCD_GRPC_KEEPALIVE_TIMEOUT=&quot;20s&quot;</span><br><span class="line">#</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://etcd03.tk8s.com:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://etcd03.tk8s.com:2379&quot;</span><br><span class="line">#ETCD_DISCOVERY=&quot;&quot;</span><br><span class="line">#ETCD_DISCOVERY_FALLBACK=&quot;proxy&quot;</span><br><span class="line">#ETCD_DISCOVERY_PROXY=&quot;&quot;</span><br><span class="line">#ETCD_DISCOVERY_SRV=&quot;&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd01.tk8s.com=https://etcd01.tk8s.com:2380,etcd02.tk8s.com=https://etcd02.tk8s.com:2380,etcd03.tk8s.com=https://etcd03.tk8s.com:2380&quot;</span><br><span class="line">#ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">#ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">#ETCD_STRICT_RECONFIG_CHECK=&quot;true&quot;</span><br><span class="line">#ETCD_ENABLE_V2=&quot;true&quot;</span><br><span class="line">#</span><br><span class="line">#[Proxy]</span><br><span class="line">#ETCD_PROXY=&quot;off&quot;</span><br><span class="line">#ETCD_PROXY_FAILURE_WAIT=&quot;5000&quot;</span><br><span class="line">#ETCD_PROXY_REFRESH_INTERVAL=&quot;30000&quot;</span><br><span class="line">#ETCD_PROXY_DIAL_TIMEOUT=&quot;1000&quot;</span><br><span class="line">#ETCD_PROXY_WRITE_TIMEOUT=&quot;5000&quot;</span><br><span class="line">#ETCD_PROXY_READ_TIMEOUT=&quot;0&quot;</span><br><span class="line">#</span><br><span class="line">#[Security]</span><br><span class="line">ETCD_CERT_FILE=&quot;/etc/etcd/pki/server.crt&quot;</span><br><span class="line">ETCD_KEY_FILE=&quot;/etc/etcd/pki/server.key&quot;</span><br><span class="line">ETCD_CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_TRUSTED_CA_FILE=&quot;/etc/etcd/pki/ca.crt&quot;</span><br><span class="line">ETCD_AUTO_TLS=&quot;false&quot;</span><br><span class="line">ETCD_PEER_CERT_FILE=&quot;/etc/etcd/pki/peer.crt&quot;</span><br><span class="line">ETCD_PEER_KEY_FILE=&quot;/etc/etcd/pki/peer.key&quot;</span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=&quot;true&quot;</span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=&quot;/etc/etcd/pki/ca.crt&quot;</span><br><span class="line">ETCD_PEER_AUTO_TLS=&quot;false&quot;</span><br><span class="line">#</span><br><span class="line">#[Logging]</span><br><span class="line">#ETCD_DEBUG=&quot;false&quot;</span><br><span class="line">#ETCD_LOG_PACKAGE_LEVELS=&quot;&quot;</span><br><span class="line">#ETCD_LOG_OUTPUT=&quot;default&quot;</span><br><span class="line">#</span><br><span class="line">#[Unsafe]</span><br><span class="line">#ETCD_FORCE_NEW_CLUSTER=&quot;false&quot;</span><br><span class="line">#</span><br><span class="line">#[Version]</span><br><span class="line">#ETCD_VERSION=&quot;false&quot;</span><br><span class="line">#ETCD_AUTO_COMPACTION_RETENTION=&quot;0&quot;</span><br><span class="line">#</span><br><span class="line">#[Profiling]</span><br><span class="line">#ETCD_ENABLE_PPROF=&quot;false&quot;</span><br><span class="line">#ETCD_METRICS=&quot;basic&quot;</span><br><span class="line">#</span><br><span class="line">#[Auth]</span><br><span class="line">#ETCD_AUTH_TOKEN=&quot;simple&quot;</span><br></pre></td></tr></table></figure>
<h3 id="启动etcd集群"><a href="#启动etcd集群" class="headerlink" title="启动etcd集群"></a>启动etcd集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# systemctl start etcd</span><br><span class="line"></span><br><span class="line">[root@master02 ~]# systemctl start etcd</span><br><span class="line"></span><br><span class="line">[root@master03 ~]# systemctl start etcd</span><br><span class="line"></span><br><span class="line">[root@master01 etcd]# ss -ntl</span><br><span class="line">State       Recv-Q Send-Q                            Local Address:Port                                           Peer Address:Port              </span><br><span class="line">LISTEN      0      128                              192.168.48.101:2379                                                      *:*                  </span><br><span class="line">LISTEN      0      128                              192.168.48.101:2380                                                      *:*                  </span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line">[root@master01 etcd]# systemctl status etcd</span><br><span class="line">● etcd.service - Etcd Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/etcd.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sat 2019-05-18 18:54:15 CST; 4min 35s ago</span><br><span class="line"> Main PID: 17796 (etcd)</span><br><span class="line">   CGroup: /system.slice/etcd.service</span><br><span class="line">           └─17796 /usr/bin/etcd --name=etcd01.tk8s.com --data-dir=/var/lib/etcd/k8s.etcd --listen-client-urls=https://192.168.48.101:2379</span><br><span class="line"></span><br><span class="line">May 18 18:54:21 master01 etcd[17796]: peer 10c0595334e9edc6 became active</span><br><span class="line">May 18 18:54:21 master01 etcd[17796]: established a TCP streaming connection with peer 10c0595334e9edc6 (stream Message writer)</span><br><span class="line">May 18 18:54:21 master01 etcd[17796]: established a TCP streaming connection with peer 10c0595334e9edc6 (stream MsgApp v2 writer)</span><br><span class="line">May 18 18:54:21 master01 etcd[17796]: established a TCP streaming connection with peer 10c0595334e9edc6 (stream MsgApp v2 reader)</span><br><span class="line">May 18 18:54:21 master01 etcd[17796]: established a TCP streaming connection with peer 10c0595334e9edc6 (stream Message reader)</span><br><span class="line">May 18 18:54:21 master01 etcd[17796]: health check for peer 10c0595334e9edc6 could not connect: dial tcp 192.168.48.103:2380: connect: connection refused (prober &quot;...T_MESSAGE&quot;)</span><br><span class="line">May 18 18:54:21 master01 etcd[17796]: health check for peer 10c0595334e9edc6 could not connect: dial tcp 192.168.48.103:2380: connect: connection refused (prober &quot;..._SNAPSHOT&quot;)</span><br><span class="line">May 18 18:54:23 master01 etcd[17796]: updating the cluster version from 3.0 to 3.3</span><br><span class="line">May 18 18:54:23 master01 etcd[17796]: updated the cluster version from 3.0 to 3.3</span><br><span class="line">May 18 18:54:23 master01 etcd[17796]: enabled capabilities for version 3.3</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br></pre></td></tr></table></figure>
<h3 id="验证etcd集群"><a href="#验证etcd集群" class="headerlink" title="验证etcd集群"></a>验证etcd集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# etcdctl --key-file=/etc/etcd/pki/client.key   --cert-file=/etc/etcd/pki/client.crt  --ca-file=/etc/etcd/pki/ca.crt --endpoints=&quot;https://etcd01.tk8s.com:2379,https://etcd02.tk8s.com:2379,https://etcd03.tk8s.com:2379&quot;  cluster-health</span><br><span class="line">member 6b6547ed3c14542 is healthy: got healthy result from https://etcd01.tk8s.com:2379</span><br><span class="line">member 10c0595334e9edc6 is healthy: got healthy result from https://etcd03.tk8s.com:2379</span><br><span class="line">member e0839a4ce2dde4b7 is healthy: got healthy result from https://etcd02.tk8s.com:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure>
<h2 id="HA部署"><a href="#HA部署" class="headerlink" title="HA部署"></a>HA部署</h2><h3 id="HA节点"><a href="#HA节点" class="headerlink" title="HA节点"></a>HA节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## 系统：7.6 内核3.10</span><br><span class="line">192.168.48.101 master01.tk8s.com etcd01.tk8s.com master01 etcd01  </span><br><span class="line">192.168.48.102 master02.tk8s.com etcd02.tk8s.com master02 etcd02</span><br><span class="line">192.168.48.103 master03.tk8s.com etcd03.tk8s.com master03 etcd03</span><br><span class="line"></span><br><span class="line">## keepalived的vip</span><br><span class="line">192.168.48.66  vip  tk8s-api.tk8s.com</span><br></pre></td></tr></table></figure>
<h3 id="安装haproxy和keepalived"><a href="#安装haproxy和keepalived" class="headerlink" title="安装haproxy和keepalived"></a>安装haproxy和keepalived</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# yum install -y keepalived haproxy</span><br></pre></td></tr></table></figure>
<h3 id="配置keepalived"><a href="#配置keepalived" class="headerlink" title="配置keepalived"></a>配置keepalived</h3><h4 id="master01-keepalived"><a href="#master01-keepalived" class="headerlink" title="master01 keepalived"></a>master01 keepalived</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# vim /etc/keepalived/keepalived.conf </span><br><span class="line"></span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 250</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass tk8s</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.48.66</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="master02-keepalived"><a href="#master02-keepalived" class="headerlink" title="master02 keepalived"></a>master02 keepalived</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@master02 ~]# vim /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 249</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass tk8s</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.48.66</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="master03-keepalived"><a href="#master03-keepalived" class="headerlink" title="master03 keepalived"></a>master03 keepalived</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@master03 ~]# vim /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 248</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass tk8s</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.48.66</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start keepalived.service </span><br><span class="line">systemctl enable keepalived.service</span><br></pre></td></tr></table></figure>
<h3 id="配置haproxy"><a href="#配置haproxy" class="headerlink" title="配置haproxy"></a>配置haproxy</h3><h4 id="所有haproxy都一样"><a href="#所有haproxy都一样" class="headerlink" title="所有haproxy都一样"></a>所有haproxy都一样</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/haproxy/haproxy.cfg</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># Example configuration for a possible web application.  See the</span><br><span class="line"># full configuration options online.</span><br><span class="line">#</span><br><span class="line">#   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</span><br><span class="line">#</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># Global settings</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">global</span><br><span class="line">    # to have these messages end up in /var/log/haproxy.log you will</span><br><span class="line">    # need to:</span><br><span class="line">    #</span><br><span class="line">    # 1) configure syslog to accept network log events.  This is done</span><br><span class="line">    #    by adding the &apos;-r&apos; option to the SYSLOGD_OPTIONS in</span><br><span class="line">    #    /etc/sysconfig/syslog</span><br><span class="line">    #</span><br><span class="line">    # 2) configure local2 events to go to the /var/log/haproxy.log</span><br><span class="line">    #   file. A line like the following can be added to</span><br><span class="line">    #   /etc/sysconfig/syslog</span><br><span class="line">    #</span><br><span class="line">    #    local2.*                       /var/log/haproxy.log</span><br><span class="line">    #</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line"></span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># common defaults that all the &apos;listen&apos; and &apos;backend&apos; sections will</span><br><span class="line"># use if not designated in their block</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># kubernetes apiserver frontend which proxys to the backends</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">frontend kubernetes-apiserver</span><br><span class="line">    mode                 tcp</span><br><span class="line">    bind                 *:8443</span><br><span class="line">    option               tcplog</span><br><span class="line">    default_backend      kubernetes-apiserver</span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># round robin balancing between the various backends</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">backend kubernetes-apiserver</span><br><span class="line">    mode        tcp</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server  master01 192.168.48.101:6443 check</span><br><span class="line">    server  master02 192.168.48.102:6443 check</span><br><span class="line">    server  master03 192.168.48.103:6443 check</span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># collection haproxy statistics message</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">listen stats</span><br><span class="line">    bind                 *:1080</span><br><span class="line">    stats auth           admin:admin</span><br><span class="line">    stats refresh        5s</span><br><span class="line">    stats realm          HAProxy\ Statistics</span><br><span class="line">    stats uri            /status</span><br></pre></td></tr></table></figure>
<h4 id="启动服务-1"><a href="#启动服务-1" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start haproxy.service</span><br><span class="line">systemctl enable haproxy.service</span><br></pre></td></tr></table></figure>
<h2 id="master-部署"><a href="#master-部署" class="headerlink" title="master 部署"></a>master 部署</h2><h3 id="master节点"><a href="#master节点" class="headerlink" title="master节点"></a>master节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.48.101 master01.tk8s.com etcd01.tk8s.com master01 etcd01</span><br><span class="line">192.168.48.102 master02.tk8s.com etcd02.tk8s.com master02 etcd02</span><br><span class="line">192.168.48.103 master03.tk8s.com etcd03.tk8s.com master03 etcd03</span><br></pre></td></tr></table></figure>
<h3 id="创建k8s证书"><a href="#创建k8s证书" class="headerlink" title="创建k8s证书"></a>创建k8s证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 cert]# bash gencerts.sh k8s</span><br><span class="line">Enter Domain Name [ilinux.io]: tk8s.com</span><br><span class="line">Enter Kubernetes Cluster Name [kubernetes]: tk8s</span><br><span class="line">Enter the IP Address in default namespace </span><br><span class="line">  of the Kubernetes API Server[10.96.0.1]: 10.96.0.1</span><br><span class="line">Enter Master servers name[master01 master02 master03]: master01 master02 master03</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">[root@master01 cert]# tree kubernetes/</span><br><span class="line">kubernetes/</span><br><span class="line">├── CA</span><br><span class="line">│   ├── ca.crt</span><br><span class="line">│   └── ca.key</span><br><span class="line">├── front-proxy</span><br><span class="line">│   ├── front-proxy-ca.crt</span><br><span class="line">│   ├── front-proxy-ca.key</span><br><span class="line">│   ├── front-proxy-client.crt</span><br><span class="line">│   └── front-proxy-client.key</span><br><span class="line">├── ingress</span><br><span class="line">│   ├── ingress-server.crt</span><br><span class="line">│   ├── ingress-server.key</span><br><span class="line">│   └── patches</span><br><span class="line">│       └── ingress-tls.patch</span><br><span class="line">├── kubelet</span><br><span class="line">│   ├── auth</span><br><span class="line">│   │   ├── bootstrap.conf</span><br><span class="line">│   │   └── kube-proxy.conf</span><br><span class="line">│   └── pki</span><br><span class="line">│       ├── ca.crt</span><br><span class="line">│       ├── kube-proxy.crt</span><br><span class="line">│       └── kube-proxy.key</span><br><span class="line">├── master01</span><br><span class="line">│   ├── auth</span><br><span class="line">│   │   ├── admin.conf</span><br><span class="line">│   │   ├── controller-manager.conf</span><br><span class="line">│   │   └── scheduler.conf</span><br><span class="line">│   ├── pki</span><br><span class="line">│   │   ├── apiserver.crt</span><br><span class="line">│   │   ├── apiserver-etcd-client.crt</span><br><span class="line">│   │   ├── apiserver-etcd-client.key</span><br><span class="line">│   │   ├── apiserver.key</span><br><span class="line">│   │   ├── apiserver-kubelet-client.crt</span><br><span class="line">│   │   ├── apiserver-kubelet-client.key</span><br><span class="line">│   │   ├── ca.crt</span><br><span class="line">│   │   ├── ca.key</span><br><span class="line">│   │   ├── front-proxy-ca.crt</span><br><span class="line">│   │   ├── front-proxy-ca.key</span><br><span class="line">│   │   ├── front-proxy-client.crt</span><br><span class="line">│   │   ├── front-proxy-client.key</span><br><span class="line">│   │   ├── kube-controller-manager.crt</span><br><span class="line">│   │   ├── kube-controller-manager.key</span><br><span class="line">│   │   ├── kube-scheduler.crt</span><br><span class="line">│   │   ├── kube-scheduler.key</span><br><span class="line">│   │   ├── sa.key</span><br><span class="line">│   │   └── sa.pub</span><br><span class="line">│   └── token.csv</span><br><span class="line">├── master02</span><br><span class="line">│   ├── auth</span><br><span class="line">│   │   ├── admin.conf</span><br><span class="line">│   │   ├── controller-manager.conf</span><br><span class="line">│   │   └── scheduler.conf</span><br><span class="line">│   ├── pki</span><br><span class="line">│   │   ├── apiserver.crt</span><br><span class="line">│   │   ├── apiserver-etcd-client.crt</span><br><span class="line">│   │   ├── apiserver-etcd-client.key</span><br><span class="line">│   │   ├── apiserver.key</span><br><span class="line">│   │   ├── apiserver-kubelet-client.crt</span><br><span class="line">│   │   ├── apiserver-kubelet-client.key</span><br><span class="line">│   │   ├── ca.crt</span><br><span class="line">│   │   ├── ca.key</span><br><span class="line">│   │   ├── front-proxy-ca.crt</span><br><span class="line">│   │   ├── front-proxy-ca.key</span><br><span class="line">│   │   ├── front-proxy-client.crt</span><br><span class="line">│   │   ├── front-proxy-client.key</span><br><span class="line">│   │   ├── kube-controller-manager.crt</span><br><span class="line">│   │   ├── kube-controller-manager.key</span><br><span class="line">│   │   ├── kube-scheduler.crt</span><br><span class="line">│   │   ├── kube-scheduler.key</span><br><span class="line">│   │   ├── sa.key</span><br><span class="line">│   │   └── sa.pub</span><br><span class="line">│   └── token.csv</span><br><span class="line">└── master03</span><br><span class="line">    ├── auth</span><br><span class="line">    │   ├── admin.conf</span><br><span class="line">    │   ├── controller-manager.conf</span><br><span class="line">    │   └── scheduler.conf</span><br><span class="line">    ├── pki</span><br><span class="line">    │   ├── apiserver.crt</span><br><span class="line">    │   ├── apiserver-etcd-client.crt</span><br><span class="line">    │   ├── apiserver-etcd-client.key</span><br><span class="line">    │   ├── apiserver.key</span><br><span class="line">    │   ├── apiserver-kubelet-client.crt</span><br><span class="line">    │   ├── apiserver-kubelet-client.key</span><br><span class="line">    │   ├── ca.crt</span><br><span class="line">    │   ├── ca.key</span><br><span class="line">    │   ├── front-proxy-ca.crt</span><br><span class="line">    │   ├── front-proxy-ca.key</span><br><span class="line">    │   ├── front-proxy-client.crt</span><br><span class="line">    │   ├── front-proxy-client.key</span><br><span class="line">    │   ├── kube-controller-manager.crt</span><br><span class="line">    │   ├── kube-controller-manager.key</span><br><span class="line">    │   ├── kube-scheduler.crt</span><br><span class="line">    │   ├── kube-scheduler.key</span><br><span class="line">    │   ├── sa.key</span><br><span class="line">    │   └── sa.pub</span><br><span class="line">    └── token.csv</span><br><span class="line"></span><br><span class="line">16 directories, 80 files</span><br></pre></td></tr></table></figure>
<h3 id="所有master节点下载server端二进制包"><a href="#所有master节点下载server端二进制包" class="headerlink" title="所有master节点下载server端二进制包"></a>所有master节点下载server端二进制包</h3><p>下载地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.14.md#downloads-for-v1142</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# wget https://dl.k8s.io/v1.14.2/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@master01 ~]# ll</span><br><span class="line">total 439272</span><br><span class="line">drwxr-xr-x 4 root root       124 May 18 17:59 cert</span><br><span class="line">-rw-r--r-- 1 root root 449810819 May 18 19:56 kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@master01 ~]# tar xvf kubernetes-server-linux-amd64.tar.gz </span><br><span class="line">[root@master01 ~]# tree kubernetes</span><br><span class="line">kubernetes</span><br><span class="line">├── addons</span><br><span class="line">├── kubernetes-src.tar.gz</span><br><span class="line">├── LICENSES</span><br><span class="line">└── server</span><br><span class="line">    └── bin</span><br><span class="line">        ├── apiextensions-apiserver</span><br><span class="line">        ├── cloud-controller-manager</span><br><span class="line">        ├── cloud-controller-manager.docker_tag</span><br><span class="line">        ├── cloud-controller-manager.tar</span><br><span class="line">        ├── hyperkube</span><br><span class="line">        ├── kubeadm</span><br><span class="line">        ├── kube-apiserver</span><br><span class="line">        ├── kube-apiserver.docker_tag</span><br><span class="line">        ├── kube-apiserver.tar</span><br><span class="line">        ├── kube-controller-manager</span><br><span class="line">        ├── kube-controller-manager.docker_tag</span><br><span class="line">        ├── kube-controller-manager.tar</span><br><span class="line">        ├── kubectl</span><br><span class="line">        ├── kubelet</span><br><span class="line">        ├── kube-proxy</span><br><span class="line">        ├── kube-proxy.docker_tag</span><br><span class="line">        ├── kube-proxy.tar</span><br><span class="line">        ├── kube-scheduler</span><br><span class="line">        ├── kube-scheduler.docker_tag</span><br><span class="line">        ├── kube-scheduler.tar</span><br><span class="line">        └── mounter</span><br><span class="line"></span><br><span class="line">3 directories, 23 files</span><br></pre></td></tr></table></figure>
<h3 id="配置master01"><a href="#配置master01" class="headerlink" title="配置master01"></a>配置master01</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">## 将解压后的服务端文件复制到/usr/local下</span><br><span class="line">[root@master01 ~]# ll</span><br><span class="line">total 439272</span><br><span class="line">drwxr-xr-x 4 root root       124 May 18 17:59 cert</span><br><span class="line">drwxr-xr-x 4 root root        79 May 17 01:02 kubernetes</span><br><span class="line">-rw-r--r-- 1 root root 449810819 May 18 19:56 kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@master01 ~]# cp -rp kubernetes  /usr/local/</span><br><span class="line"></span><br><span class="line">## 将/usr/local/kubernetes/server/bin添加到PATH</span><br><span class="line">[root@master01 ~]# echo &quot;export PATH=$PATH:/usr/local/kubernetes/server/bin&quot; &gt; /etc/profile.d/k8s_path.sh</span><br><span class="line">[root@master01 ~]# source  /etc/profile.d/k8s_path.sh </span><br><span class="line"></span><br><span class="line">## 创建目录</span><br><span class="line">[root@master01 ~]# mkdir -p /etc/kubernetes</span><br><span class="line">[root@master01 ~]# mkdir -p /etc/kubernetes/manifests</span><br><span class="line"></span><br><span class="line">## 将master01证书文件复制到/etc/kubernetes</span><br><span class="line">[root@master01 ~]# cp -rp /root/cert/kubernetes/master01/*  /etc/kubernetes/</span><br><span class="line">[root@master01 ~]# cd /etc/kubernetes/</span><br><span class="line">[root@master01 kubernetes]# ll</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 root root   77 May 18 17:59 auth</span><br><span class="line">drwxr-xr-x 2 root root 4096 May 18 17:59 pki</span><br><span class="line">-rw-r--r-- 1 root root   75 May 18 17:59 token.csv</span><br><span class="line"></span><br><span class="line">##将kubelet的bootstrap.conf复制到/etc/kubernetes/auth</span><br><span class="line">[root@master01 ~]# cp -rp /root/cert/kubernetes/kubelet/auth/bootstrap.conf  /etc/kubernetes/auth/</span><br><span class="line"></span><br><span class="line">##将kubelet的kube-proxy.conf复制到/etc/kubernetes/auth</span><br><span class="line">[root@master01 ~]# cp -rp /root/cert/kubernetes/kubelet/auth/kube-proxy.conf  /etc/kubernetes/auth/</span><br><span class="line"></span><br><span class="line">##修改auth/bootstrap.conf </span><br><span class="line">[root@master01 ~]# sed -i &apos;s/:6443/:8443/&apos; /etc/kubernetes/auth/bootstrap.conf</span><br><span class="line"></span><br><span class="line">##修改kube-proxy.conf</span><br><span class="line">[root@master01 ~]# sed -i &apos;s/:6443/:8443/&apos; /etc/kubernetes/auth/kube-proxy.conf</span><br><span class="line"></span><br><span class="line">## 编写配置文件到/etc/kubernetes</span><br><span class="line">[root@master01 ~]# cd /etc/kubernetes/</span><br><span class="line">[root@master01 kubernetes]# ll</span><br><span class="line">total 32</span><br><span class="line">-rw-r--r-- 1 root root 2064 May 19 14:12 apiserver</span><br><span class="line">drwxr-xr-x 2 root root  142 May 19 17:38 auth</span><br><span class="line">-rw-r--r-- 1 root root  538 Mar  2 17:48 config</span><br><span class="line">-rw-r--r-- 1 root root 1018 Mar  2 17:48 controller-manager</span><br><span class="line">-rw-r--r-- 1 root root  446 Mar  2 17:48 kubelet</span><br><span class="line">drwxr-xr-x 2 root root    6 May 19 11:31 manifests</span><br><span class="line">drwxr-xr-x 2 root root 4096 May 18 17:59 pki</span><br><span class="line">-rw-r--r-- 1 root root  106 May 19 17:37 proxy</span><br><span class="line">-rw-r--r-- 1 root root  211 Mar  2 17:48 scheduler</span><br><span class="line">-rw-r--r-- 1 root root   75 May 18 17:59 token.csv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 配置启动文件到/usr/lib/systemd/system/</span><br><span class="line">[root@master01 ~]# ll /usr/lib/systemd/system/kube*</span><br><span class="line">-rw-r--r-- 1 root root 644 Mar  2 17:48 /usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line">-rw-r--r-- 1 root root 473 Mar  2 17:48 /usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line">-rw-r--r-- 1 root root 609 May 19 12:03 /usr/lib/systemd/system/kubelet.service</span><br><span class="line">-rw-r--r-- 1 root root 444 May 19 18:49 /usr/lib/systemd/system/kube-proxy.service</span><br><span class="line">-rw-r--r-- 1 root root 444 Mar  2 17:48 /usr/lib/systemd/system/kube-scheduler.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 创建工作目录并编写config.yaml配置文件</span><br><span class="line">[root@master01 ~]# mkdir /var/lib/kubelet -p</span><br><span class="line">[root@master01 ~]# cd /var/lib/kubelet/</span><br><span class="line">[root@master01 kubelet]# ll</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 1713 Mar  2 17:48 config.yaml</span><br><span class="line">[root@master01 ~]# mkdir /var/lib/kube-proxy -p</span><br><span class="line">[root@master01 ~]# cd /var/lib/kube-proxy/</span><br><span class="line">[root@master01 kubelet]# ll</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 1713 Mar  2 17:48 config.yaml</span><br><span class="line"></span><br><span class="line">## 创建kube用户以及工作目录</span><br><span class="line">[root@master01 ~]# useradd -r kube</span><br><span class="line">[root@master01 ~]# mkdir /var/run/kubernetes</span><br><span class="line">[root@master01 ~]# chown kube.kube /var/run/kubernetes/</span><br></pre></td></tr></table></figure>
<h4 id="编辑-etc-kubernetes-中配置文件"><a href="#编辑-etc-kubernetes-中配置文件" class="headerlink" title="编辑/etc/kubernetes/中配置文件"></a>编辑/etc/kubernetes/中配置文件</h4><h5 id="编辑kubelet"><a href="#编辑kubelet" class="headerlink" title="编辑kubelet"></a>编辑kubelet</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim kubelet </span><br><span class="line"></span><br><span class="line">###</span><br><span class="line"># kubernetes kubelet config</span><br><span class="line"></span><br><span class="line"># The address for the info server to serve on (set to 0.0.0.0 or &quot;&quot; for all interfaces)</span><br><span class="line">KUBELET_ADDRESS=&quot;--address=0.0.0.0&quot;</span><br><span class="line"></span><br><span class="line"># The port for the info server to serve on</span><br><span class="line"># KUBELET_PORT=&quot;--port=10250&quot;</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBELET_ARGS=&quot;--network-plugin=cni \</span><br><span class="line">    --config=/var/lib/kubelet/config.yaml \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/auth/kubelet.conf \</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/auth/bootstrap.conf&quot;</span><br></pre></td></tr></table></figure>
<h5 id="编辑apiserver"><a href="#编辑apiserver" class="headerlink" title="编辑apiserver"></a>编辑apiserver</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">vim apiserver</span><br><span class="line"></span><br><span class="line">###</span><br><span class="line"># kubernetes system config</span><br><span class="line">#</span><br><span class="line"># The following values are used to configure the kube-apiserver</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># The address on the local server to listen to.</span><br><span class="line">KUBE_API_ADDRESS=&quot;--advertise-address=0.0.0.0&quot;</span><br><span class="line"></span><br><span class="line"># The port on the local server to listen on.</span><br><span class="line">KUBE_API_PORT=&quot;--secure-port=6443 --insecure-port=0&quot;</span><br><span class="line"></span><br><span class="line"># Comma separated list of nodes in the etcd cluster</span><br><span class="line">KUBE_ETCD_SERVERS=&quot;--etcd-servers=https://etcd01.tk8s.com:2379,https://etcd02.tk8s.com:2379,https://etcd03.tk8s.com:2379&quot;</span><br><span class="line"></span><br><span class="line"># Address range to use for services</span><br><span class="line">KUBE_SERVICE_ADDRESSES=&quot;--service-cluster-ip-range=10.96.0.0/12&quot;</span><br><span class="line"></span><br><span class="line"># default admission control policies</span><br><span class="line">KUBE_ADMISSION_CONTROL=&quot;--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,NodeRestriction&quot;</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBE_API_ARGS=&quot;--authorization-mode=Node,RBAC \</span><br><span class="line">    --client-ca-file=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">    --enable-bootstrap-token-auth=true \</span><br><span class="line">    --etcd-cafile=/etc/etcd/pki/ca.crt \</span><br><span class="line">    --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt \</span><br><span class="line">    --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key \</span><br><span class="line">    --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt \</span><br><span class="line">    --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key \</span><br><span class="line">    --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">    --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt \</span><br><span class="line">    --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key \</span><br><span class="line">    --requestheader-allowed-names=front-proxy-client \</span><br><span class="line">    --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt \</span><br><span class="line">    --requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">    --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">    --requestheader-username-headers=X-Remote-User\</span><br><span class="line">    --service-account-key-file=/etc/kubernetes/pki/sa.pub \</span><br><span class="line">    --tls-cert-file=/etc/kubernetes/pki/apiserver.crt \</span><br><span class="line">    --tls-private-key-file=/etc/kubernetes/pki/apiserver.key \</span><br><span class="line">    --token-auth-file=/etc/kubernetes/token.csv&quot;</span><br></pre></td></tr></table></figure>
<h5 id="编辑config"><a href="#编辑config" class="headerlink" title="编辑config"></a>编辑config</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim config</span><br><span class="line"></span><br><span class="line">###</span><br><span class="line"># kubernetes system config</span><br><span class="line">#</span><br><span class="line"># The following values are used to configure various aspects of all</span><br><span class="line"># kubernetes services, including</span><br><span class="line">#</span><br><span class="line">#   kube-apiserver.service</span><br><span class="line">#   kube-controller-manager.service</span><br><span class="line">#   kube-scheduler.service</span><br><span class="line">#   kubelet.service</span><br><span class="line">#   kube-proxy.service</span><br><span class="line"># logging to stderr means we get it in the systemd journal</span><br><span class="line">KUBE_LOGTOSTDERR=&quot;--logtostderr=true&quot;</span><br><span class="line"></span><br><span class="line"># journal message level, 0 is debug</span><br><span class="line">KUBE_LOG_LEVEL=&quot;--v=0&quot;</span><br><span class="line"></span><br><span class="line"># Should this cluster be allowed to run privileged docker containers</span><br><span class="line">KUBE_ALLOW_PRIV=&quot;--allow-privileged=true&quot;</span><br></pre></td></tr></table></figure>
<h5 id="编辑controller-manager"><a href="#编辑controller-manager" class="headerlink" title="编辑controller-manager"></a>编辑controller-manager</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim controller-manager</span><br><span class="line"></span><br><span class="line">###</span><br><span class="line"># The following values are used to configure the kubernetes controller-manager</span><br><span class="line"></span><br><span class="line"># defaults from config and apiserver should be adequate</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=&quot;--bind-address=127.0.0.1 \</span><br><span class="line">    --allocate-node-cidrs=true \</span><br><span class="line">    --authentication-kubeconfig=/etc/kubernetes/auth/controller-manager.conf \</span><br><span class="line">    --authorization-kubeconfig=/etc/kubernetes/auth/controller-manager.conf \</span><br><span class="line">    --client-ca-file=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">    --cluster-cidr=10.244.0.0/16 \</span><br><span class="line">    --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">    --cluster-signing-key-file=/etc/kubernetes/pki/ca.key \</span><br><span class="line">    --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/auth/controller-manager.conf \</span><br><span class="line">    --leader-elect=true \</span><br><span class="line">    --node-cidr-mask-size=24 \</span><br><span class="line">    --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt \</span><br><span class="line">    --root-ca-file=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">    --service-account-private-key-file=/etc/kubernetes/pki/sa.key \</span><br><span class="line">    --use-service-account-credentials=true&quot;</span><br></pre></td></tr></table></figure>
<h5 id="编辑scheduler"><a href="#编辑scheduler" class="headerlink" title="编辑scheduler"></a>编辑scheduler</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim scheduler</span><br><span class="line"></span><br><span class="line">###</span><br><span class="line"># kubernetes scheduler config</span><br><span class="line"></span><br><span class="line"># default config should be adequate</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBE_SCHEDULER_ARGS=&quot;--address=127.0.0.1 \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/auth/scheduler.conf \</span><br><span class="line">    --leader-elect=true&quot;</span><br></pre></td></tr></table></figure>
<h5 id="编辑proxy"><a href="#编辑proxy" class="headerlink" title="编辑proxy"></a>编辑proxy</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim proxy</span><br><span class="line"></span><br><span class="line">###</span><br><span class="line"># kubernetes proxy config</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBE_PROXY_ARGS=&quot;--config=/var/lib/kube-proxy/config.yaml&quot;</span><br></pre></td></tr></table></figure>
<p>#### </p>
<h4 id="编辑-usr-lib-systemed-system-中启动文件"><a href="#编辑-usr-lib-systemed-system-中启动文件" class="headerlink" title="编辑/usr/lib/systemed/system/中启动文件"></a>编辑/usr/lib/systemed/system/中启动文件</h4><h5 id="编辑kube-apiserver-service"><a href="#编辑kube-apiserver-service" class="headerlink" title="编辑kube-apiserver.service"></a>编辑kube-apiserver.service</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vim  kube-apiserver.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line">After=etcd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/apiserver</span><br><span class="line">User=kube</span><br><span class="line">ExecStart=/usr/local/kubernetes/server/bin/kube-apiserver \</span><br><span class="line">	    $KUBE_LOGTOSTDERR \</span><br><span class="line">	    $KUBE_LOG_LEVEL \</span><br><span class="line">	    $KUBE_ETCD_SERVERS \</span><br><span class="line">	    $KUBE_API_ADDRESS \</span><br><span class="line">	    $KUBE_API_PORT \</span><br><span class="line">	    $KUBELET_PORT \</span><br><span class="line">	    $KUBE_ALLOW_PRIV \</span><br><span class="line">	    $KUBE_SERVICE_ADDRESSES \</span><br><span class="line">	    $KUBE_ADMISSION_CONTROL \</span><br><span class="line">	    $KUBE_API_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h5 id="编辑kube-controller-manager-service"><a href="#编辑kube-controller-manager-service" class="headerlink" title="编辑kube-controller-manager.service"></a>编辑kube-controller-manager.service</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim kube-controller-manager.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/controller-manager</span><br><span class="line">User=kube</span><br><span class="line">ExecStart=/usr/local/kubernetes/server/bin/kube-controller-manager \</span><br><span class="line">	    $KUBE_LOGTOSTDERR \</span><br><span class="line">	    $KUBE_LOG_LEVEL \</span><br><span class="line">	    $KUBE_MASTER \</span><br><span class="line">	    $KUBE_CONTROLLER_MANAGER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h5 id="编辑kube-scheduler-service"><a href="#编辑kube-scheduler-service" class="headerlink" title="编辑kube-scheduler.service"></a>编辑kube-scheduler.service</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim kube-scheduler.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler Plugin</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/scheduler</span><br><span class="line">User=kube</span><br><span class="line">ExecStart=/usr/local/kubernetes/server/bin/kube-scheduler \</span><br><span class="line">	    $KUBE_LOGTOSTDERR \</span><br><span class="line">	    $KUBE_LOG_LEVEL \</span><br><span class="line">	    $KUBE_MASTER \</span><br><span class="line">	    $KUBE_SCHEDULER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h5 id="编辑kubelet-service"><a href="#编辑kubelet-service" class="headerlink" title="编辑kubelet.service"></a>编辑kubelet.service</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vim kubelet.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kubelet</span><br><span class="line">ExecStart=/usr/local/kubernetes/server/bin/kubelet \</span><br><span class="line">	    $KUBE_LOGTOSTDERR \</span><br><span class="line">	    $KUBE_LOG_LEVEL \</span><br><span class="line">	    $KUBELET_API_SERVER \</span><br><span class="line">	    $KUBELET_ADDRESS \</span><br><span class="line">	    $KUBELET_PORT \</span><br><span class="line">	    $KUBELET_HOSTNAME \</span><br><span class="line">	    $KUBE_ALLOW_PRIV \</span><br><span class="line">	    $KUBELET_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line">RestartSec=10</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h5 id="编辑kube-proxy-service"><a href="#编辑kube-proxy-service" class="headerlink" title="编辑kube-proxy.service"></a>编辑kube-proxy.service</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim kube-proxy.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/proxy</span><br><span class="line">ExecStart=/usr/local/kubernetes/server/bin/kube-proxy \</span><br><span class="line">	    $KUBE_LOGTOSTDERR \</span><br><span class="line">	    $KUBE_LOG_LEVEL \</span><br><span class="line">	    $KUBE_MASTER \</span><br><span class="line">	    $KUBE_PROXY_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>#### </p>
<h4 id="编辑-var-lib中config-yaml文件"><a href="#编辑-var-lib中config-yaml文件" class="headerlink" title="编辑/var/lib中config.yaml文件"></a>编辑/var/lib中config.yaml文件</h4><h5 id="编辑kubelet的config-yaml"><a href="#编辑kubelet的config-yaml" class="headerlink" title="编辑kubelet的config.yaml"></a>编辑kubelet的config.yaml</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/kubelet/config.yaml</span><br><span class="line"></span><br><span class="line">address: 0.0.0.0</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.crt</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">cgroupsPerQOS: true</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">configMapAndSecretChangeDetectionStrategy: Watch</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: true</span><br><span class="line">cpuCFSQuotaPeriod: 100ms</span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: true</span><br><span class="line">enableDebuggingHandlers: true</span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line">failSwapOn: false</span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS: 5</span><br><span class="line">makeIPTablesUtilChains: true</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">nodeLeaseDurationSeconds: 40</span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">podPidsLimit: -1</span><br><span class="line">port: 10250</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 5</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line">serializeImagePulls: true</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br></pre></td></tr></table></figure>
<h5 id="编辑kube-proxy的config-yaml"><a href="#编辑kube-proxy的config-yaml" class="headerlink" title="编辑kube-proxy的config.yaml"></a>编辑kube-proxy的config.yaml</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/kubelet/config.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 10</span><br><span class="line">  contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">  kubeconfig: /etc/kubernetes/auth/kube-proxy.conf</span><br><span class="line">  qps: 5</span><br><span class="line">clusterCIDR: 10.244.0.0/16</span><br><span class="line">configSyncPeriod: 15m0s</span><br><span class="line">conntrack:</span><br><span class="line">  max: null</span><br><span class="line">  maxPerCore: 32768</span><br><span class="line">  min: 131072</span><br><span class="line">  tcpCloseWaitTimeout: 1h0m0s</span><br><span class="line">  tcpEstablishedTimeout: 24h0m0s</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">hostnameOverride: &quot;&quot;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: 14</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  scheduler: &quot;&quot;</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">mode: ipvs</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">portRange: &quot;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="配置master02"><a href="#配置master02" class="headerlink" title="配置master02"></a>配置master02</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master02 ~]# mkdir -p /etc/kubernetes</span><br><span class="line">[root@master02 ~]# mkdir -p /etc/kubernetes/manifests</span><br><span class="line">[root@master02 ~]# useradd -r kube</span><br><span class="line">[root@master02 ~]# mkdir /var/run/kubernetes</span><br><span class="line">[root@master02 ~]# chown kube.kube /var/run/kubernetes/</span><br><span class="line">[root@master02 ~]# mkdir /var/lib/kubelet -p</span><br><span class="line">[root@master02 ~]# mkdir /var/lib/kube-proxy -p</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# scp -rp kubernetes  master02:/usr/local</span><br><span class="line">[root@master01 ~]# scp -rp /root/cert/kubernetes/master02/*  master02:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/apiserver  master02:/etc/kubernetes/     </span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/config   master02:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/scheduler     master02:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/kubelet      master02:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/controller-manager    master02:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/proxy    master02:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/auth/bootstrap.conf  master02:/etc/kubernetes/auth/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/auth/kube-proxy.conf  master02:/etc/kubernetes/auth/</span><br><span class="line">[root@master01 ~]# scp /usr/lib/systemd/system/kube*  master02:/usr/lib/systemd/system/</span><br><span class="line">[root@master01 ~]# scp /var/lib/kubelet/config.yaml  master02:/var/lib/kubelet/</span><br><span class="line">[root@master01 ~]# scp /var/lib/kube-proxy/config.yaml  master02:/var/lib/kube-proxy/</span><br><span class="line"></span><br><span class="line">[root@master02 ~]# echo &quot;export PATH=$PATH:/usr/local/kubernetes/server/bin&quot; &gt; /etc/profile.d/k8s_path.sh</span><br><span class="line">[root@master02 ~]# source  /etc/profile.d/k8s_path.sh</span><br></pre></td></tr></table></figure>
<h3 id="配置master03"><a href="#配置master03" class="headerlink" title="配置master03"></a>配置master03</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master03 ~]# mkdir -p /etc/kubernetes</span><br><span class="line">[root@master03 ~]# mkdir -p /etc/kubernetes/manifests</span><br><span class="line">[root@master03 ~]# useradd -r kube</span><br><span class="line">[root@master03 ~]# mkdir /var/run/kubernetes</span><br><span class="line">[root@master03 ~]# chown kube.kube /var/run/kubernetes/</span><br><span class="line">[root@master03 ~]# mkdir /var/lib/kubelet -p</span><br><span class="line">[root@master03 ~]# mkdir /var/lib/kube-proxy -p</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# scp -rp kubernetes  master03:/usr/local</span><br><span class="line">[root@master01 ~]# scp -rp /root/cert/kubernetes/master03/*  master03:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/apiserver  master03:/etc/kubernetes/     </span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/config   master03:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/scheduler     master03:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/kubelet      master03:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/controller-manager    master03:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/proxy    master03:/etc/kubernetes/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/auth/bootstrap.conf  master03:/etc/kubernetes/auth/</span><br><span class="line">[root@master01 ~]# scp /etc/kubernetes/auth/kube-proxy.conf  master03:/etc/kubernetes/auth/</span><br><span class="line">[root@master01 ~]# scp /usr/lib/systemd/system/kube*  master03:/usr/lib/systemd/system/</span><br><span class="line">[root@master01 ~]# scp /var/lib/kubelet/config.yaml  master03:/var/lib/kubelet/</span><br><span class="line">[root@master01 ~]# scp /var/lib/kube-proxy/config.yaml  master03:/var/lib/kube-proxy/</span><br><span class="line"></span><br><span class="line">[root@master03 ~]# echo &quot;export PATH=$PATH:/usr/local/kubernetes/server/bin&quot; &gt; /etc/profile.d/k8s_path.sh</span><br><span class="line">[root@master03 ~]# source  /etc/profile.d/k8s_path.sh</span><br></pre></td></tr></table></figure>
<h3 id="所有master节点启动master集群"><a href="#所有master节点启动master集群" class="headerlink" title="所有master节点启动master集群"></a>所有master节点启动master集群</h3><h4 id="启动apiserver"><a href="#启动apiserver" class="headerlink" title="启动apiserver"></a>启动apiserver</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl start kube-apiserver.service </span><br><span class="line">systemctl enable kube-apiserver.service</span><br></pre></td></tr></table></figure>
<h4 id="配置kubectl"><a href="#配置kubectl" class="headerlink" title="配置kubectl"></a>配置kubectl</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir .kube</span><br><span class="line">cp /etc/kubernetes/auth/admin.conf .kube/config</span><br></pre></td></tr></table></figure>
<h4 id="kubectl自动补全"><a href="#kubectl自动补全" class="headerlink" title="kubectl自动补全"></a>kubectl自动补全</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install bash-completion*</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>
<h4 id="创建clusterrolebinding-绑定bootstapper"><a href="#创建clusterrolebinding-绑定bootstapper" class="headerlink" title="创建clusterrolebinding  绑定bootstapper"></a>创建clusterrolebinding  绑定bootstapper</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding system:bootstrapper --user=system:bootstrapper  --clusterrole=system:node-bootstrapper</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:bootstrapper created</span><br></pre></td></tr></table></figure>
<h4 id="启动kube-controller-manager-service"><a href="#启动kube-controller-manager-service" class="headerlink" title="启动kube-controller-manager.service"></a>启动kube-controller-manager.service</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kube-controller-manager.service </span><br><span class="line">systemctl enable kube-controller-manager.service</span><br></pre></td></tr></table></figure>
<h4 id="启动kube-scheduler-service"><a href="#启动kube-scheduler-service" class="headerlink" title="启动kube-scheduler.service"></a>启动kube-scheduler.service</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kube-scheduler.service</span><br><span class="line">systemctl enable kube-scheduler.service</span><br></pre></td></tr></table></figure>
<h4 id="检查master是否成功启动"><a href="#检查master是否成功启动" class="headerlink" title="检查master是否成功启动"></a>检查master是否成功启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="启动kubelet"><a href="#启动kubelet" class="headerlink" title="启动kubelet"></a>启动kubelet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kubelet.service </span><br><span class="line">systemctl enbale kubelet.service</span><br></pre></td></tr></table></figure>
<h4 id="启动kube-proxy"><a href="#启动kube-proxy" class="headerlink" title="启动kube-proxy"></a>启动kube-proxy</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> systemctl start kube-proxy.service </span><br><span class="line"> systemctl enable kube-proxy.service</span><br><span class="line"></span><br><span class="line"> ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.96.0.1:443 rr</span><br><span class="line">  -&gt; 192.168.48.101:6443          Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.48.102:6443          Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.48.103:6443          Masq    1      0          0</span><br></pre></td></tr></table></figure>
<h4 id="签发master证书"><a href="#签发master证书" class="headerlink" title="签发master证书"></a>签发master证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl get csr</span><br><span class="line">NAME        AGE     REQUESTOR             CONDITION</span><br><span class="line">csr-nwzz5   9m53s   system:bootstrapper   Pending</span><br><span class="line">csr-vl24p   9m52s   system:bootstrapper   Pending</span><br><span class="line">csr-xnmjm   3m21s   system:bootstrapper   Pending</span><br><span class="line">[root@master01 ~]# kubectl certificate approve csr-nwzz5</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-nwzz5 approved</span><br><span class="line">[root@master01 ~]# kubectl certificate approve csr-vl24p </span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-vl24p approved</span><br><span class="line">[root@master01 ~]# kubectl certificate approve csr-xnmjm</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-xnmjm approved</span><br><span class="line"></span><br><span class="line">kubectl get node</span><br><span class="line">NAME       STATUS     ROLES    AGE   VERSION</span><br><span class="line">master01   NotReady   &lt;none&gt;   38s   v1.14.2</span><br><span class="line">master02   NotReady   &lt;none&gt;   15s   v1.14.2</span><br><span class="line">master03   NotReady   &lt;none&gt;   6s    v1.14.2</span><br></pre></td></tr></table></figure>
<h2 id="node部署"><a href="#node部署" class="headerlink" title="node部署"></a>node部署</h2><h3 id="node节点"><a href="#node节点" class="headerlink" title="node节点"></a>node节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.48.201 node01.tk8s.com   node01</span><br><span class="line">192.168.48.202 node02.tk8s.com   node02</span><br><span class="line">192.168.48.203 node03.tk8s.com   node03</span><br></pre></td></tr></table></figure>
<h3 id="所有node节点下载node二进制包"><a href="#所有node节点下载node二进制包" class="headerlink" title="所有node节点下载node二进制包"></a>所有node节点下载node二进制包</h3><p>下载地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.14.md#downloads-for-v1142</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# wget https://dl.k8s.io/v1.14.2/kubernetes-node-linux-amd64.tar.gz</span><br><span class="line">[root@node01 ~]# ll</span><br><span class="line">total 119388</span><br><span class="line">-rw-r--r-- 1 root root 97638420 May 18 19:16 kubernetes-node-linux-amd64.tar.gz</span><br><span class="line">[root@node01 ~]# tar xvf kubernetes-node-linux-amd64.tar.gz </span><br><span class="line">kubernetes/</span><br><span class="line">kubernetes/LICENSES</span><br><span class="line">kubernetes/kubernetes-src.tar.gz</span><br><span class="line">kubernetes/node/</span><br><span class="line">kubernetes/node/bin/</span><br><span class="line">kubernetes/node/bin/kubectl</span><br><span class="line">kubernetes/node/bin/kube-proxy</span><br><span class="line">kubernetes/node/bin/kubelet</span><br><span class="line">kubernetes/node/bin/kubeadm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 将解压的文件复制到/usr/local</span><br><span class="line">[root@node01 ~]# cp -rp kubernetes  /usr/local/</span><br><span class="line"></span><br><span class="line">## 将/usr/local/kubernetes/node/bin添加到PATH </span><br><span class="line">[root@node01 ~]# echo &quot;export PATH=$PATH:/usr/local/kubernetes/node/bin&quot; &gt; /etc/profile.d/node_path.sh</span><br><span class="line">[root@node01 ~]# source  /etc/profile.d/node_path.sh</span><br></pre></td></tr></table></figure>
<h3 id="配置node01"><a href="#配置node01" class="headerlink" title="配置node01"></a>配置node01</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">## 创建证书目录</span><br><span class="line">[root@node01 ~]# mkdir /etc/kubernetes</span><br><span class="line">[root@node01 ~]# cd /etc/kubernetes</span><br><span class="line">[root@node01 kubernetes]# mkdir manifests</span><br><span class="line"></span><br><span class="line">## 复制kubelet所有文件到/etc/kubernetes</span><br><span class="line">[root@master01 ~]# scp -rp /root/cert/kubernetes/kubelet/* node01:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">## 编写配置文件到/etc/kubernetes</span><br><span class="line">[root@node01 kubernetes]# ll</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 root root  51 May 18 17:59 auth</span><br><span class="line">-rw-r--r-- 1 root root 538 Mar  2 17:48 config</span><br><span class="line">-rw-r--r-- 1 root root 446 Mar  2 17:48 kubelet</span><br><span class="line">drwxr-xr-x 2 root root  64 May 18 17:59 pki</span><br><span class="line">-rw-r--r-- 1 root root 106 Mar  2 17:48 proxy</span><br><span class="line"></span><br><span class="line">## 配置启动文件到/usr/lib/systemd/system/</span><br><span class="line">[root@node01 ~]# cd /usr/lib/systemd/system/</span><br><span class="line">[root@node01 system]# ll kube*</span><br><span class="line">-rw-r--r-- 1 root root 607 Mar  2 17:48 kubelet.service</span><br><span class="line">-rw-r--r-- 1 root root 442 Mar  2 17:48 kube-proxy.service</span><br><span class="line"></span><br><span class="line">## 修改/etc/kubernetes/auth/bootstrap.conf</span><br><span class="line">[root@node01 auth]# sed -i &apos;s/:6443/:8443/&apos; /etc/kubernetes/auth/bootstrap.conf</span><br><span class="line"></span><br><span class="line">## 修改/etc/kubernetes/auth/kube-proxy.conf</span><br><span class="line">[root@node01 auth]# sed -i &apos;s/:6443/:8443/&apos; /etc/kubernetes/auth/kube-proxy.conf</span><br><span class="line"></span><br><span class="line">## 创建工作目录并编写config.yaml配置文件</span><br><span class="line">[root@node01 ~]# mkdir /var/lib/kubelet -p</span><br><span class="line">[root@node01 ~]# mkdir /var/lib/kube-proxy -p</span><br><span class="line">[root@node01 ~]# tree  /var/lib/kube*</span><br><span class="line">/var/lib/kubelet</span><br><span class="line">└── config.yaml</span><br><span class="line">/var/lib/kube-proxy</span><br><span class="line">└── config.yaml</span><br><span class="line"></span><br><span class="line">0 directories, 2 files</span><br></pre></td></tr></table></figure>
<h4 id="编辑-etc-kubernetes-中配置文件-1"><a href="#编辑-etc-kubernetes-中配置文件-1" class="headerlink" title="编辑/etc/kubernetes/中配置文件"></a>编辑/etc/kubernetes/中配置文件</h4><h5 id="编辑kubelet-1"><a href="#编辑kubelet-1" class="headerlink" title="编辑kubelet"></a>编辑kubelet</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim kubelet </span><br><span class="line"></span><br><span class="line">###</span><br><span class="line"># kubernetes kubelet config</span><br><span class="line"></span><br><span class="line"># The address for the info server to serve on (set to 0.0.0.0 or &quot;&quot; for all interfaces)</span><br><span class="line">KUBELET_ADDRESS=&quot;--address=0.0.0.0&quot;</span><br><span class="line"></span><br><span class="line"># The port for the info server to serve on</span><br><span class="line"># KUBELET_PORT=&quot;--port=10250&quot;</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBELET_ARGS=&quot;--network-plugin=cni \</span><br><span class="line">    --config=/var/lib/kubelet/config.yaml \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/auth/kubelet.conf \</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/auth/bootstrap.conf&quot;</span><br></pre></td></tr></table></figure>
<h5 id="编辑config-1"><a href="#编辑config-1" class="headerlink" title="编辑config"></a>编辑config</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim config</span><br><span class="line"></span><br><span class="line">###</span><br><span class="line"># kubernetes proxy config</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBE_PROXY_ARGS=&quot;--config=/var/lib/kube-proxy/config.yaml&quot;</span><br></pre></td></tr></table></figure>
<h5 id="编辑proxy-1"><a href="#编辑proxy-1" class="headerlink" title="编辑proxy"></a>编辑proxy</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim proxy</span><br><span class="line"></span><br><span class="line">###</span><br><span class="line"># kubernetes proxy config</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBE_PROXY_ARGS=&quot;--config=/var/lib/kube-proxy/config.yaml&quot;</span><br></pre></td></tr></table></figure>
<h4 id="编辑-usr-lib-systemed-system-中启动文件-1"><a href="#编辑-usr-lib-systemed-system-中启动文件-1" class="headerlink" title="编辑/usr/lib/systemed/system/中启动文件"></a>编辑/usr/lib/systemed/system/中启动文件</h4><h5 id="编辑kubelet-service-1"><a href="#编辑kubelet-service-1" class="headerlink" title="编辑kubelet.service"></a>编辑kubelet.service</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vim kubelet.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kubelet</span><br><span class="line">ExecStart=/usr/local/kubernetes/node/bin/kubelet \</span><br><span class="line">	    $KUBE_LOGTOSTDERR \</span><br><span class="line">	    $KUBE_LOG_LEVEL \</span><br><span class="line">	    $KUBELET_API_SERVER \</span><br><span class="line">	    $KUBELET_ADDRESS \</span><br><span class="line">	    $KUBELET_PORT \</span><br><span class="line">	    $KUBELET_HOSTNAME \</span><br><span class="line">	    $KUBE_ALLOW_PRIV \</span><br><span class="line">	    $KUBELET_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line">RestartSec=10</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h5 id="编辑kube-proxy-service-1"><a href="#编辑kube-proxy-service-1" class="headerlink" title="编辑kube-proxy.service"></a>编辑kube-proxy.service</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim kube-proxy.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/proxy</span><br><span class="line">ExecStart=/usr/local/kubernetes/node/bin/kube-proxy \</span><br><span class="line">	    $KUBE_LOGTOSTDERR \</span><br><span class="line">	    $KUBE_LOG_LEVEL \</span><br><span class="line">	    $KUBE_MASTER \</span><br><span class="line">	    $KUBE_PROXY_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h4 id="编辑-var-lib中config-yaml文件-1"><a href="#编辑-var-lib中config-yaml文件-1" class="headerlink" title="编辑/var/lib中config.yaml文件"></a>编辑/var/lib中config.yaml文件</h4><h5 id="编辑kubelet的config-yaml-1"><a href="#编辑kubelet的config-yaml-1" class="headerlink" title="编辑kubelet的config.yaml"></a>编辑kubelet的config.yaml</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/kubelet/config.yaml</span><br><span class="line"></span><br><span class="line">address: 0.0.0.0</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.crt</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">cgroupsPerQOS: true</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">configMapAndSecretChangeDetectionStrategy: Watch</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: true</span><br><span class="line">cpuCFSQuotaPeriod: 100ms</span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: true</span><br><span class="line">enableDebuggingHandlers: true</span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line">failSwapOn: false</span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS: 5</span><br><span class="line">makeIPTablesUtilChains: true</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">nodeLeaseDurationSeconds: 40</span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">podPidsLimit: -1</span><br><span class="line">port: 10250</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 5</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line">serializeImagePulls: true</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br></pre></td></tr></table></figure>
<h5 id="编辑kube-proxy的config-yaml-1"><a href="#编辑kube-proxy的config-yaml-1" class="headerlink" title="编辑kube-proxy的config.yaml"></a>编辑kube-proxy的config.yaml</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/kubelet/config.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 10</span><br><span class="line">  contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">  kubeconfig: /etc/kubernetes/auth/kube-proxy.conf</span><br><span class="line">  qps: 5</span><br><span class="line">clusterCIDR: 10.244.0.0/16</span><br><span class="line">configSyncPeriod: 15m0s</span><br><span class="line">conntrack:</span><br><span class="line">  max: null</span><br><span class="line">  maxPerCore: 32768</span><br><span class="line">  min: 131072</span><br><span class="line">  tcpCloseWaitTimeout: 1h0m0s</span><br><span class="line">  tcpEstablishedTimeout: 24h0m0s</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">hostnameOverride: &quot;&quot;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: 14</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  scheduler: &quot;&quot;</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">mode: ipvs</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">portRange: &quot;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="配置node02"><a href="#配置node02" class="headerlink" title="配置node02"></a>配置node02</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 ~]# mkdir -p /etc/kubernetes</span><br><span class="line">[root@node02 ~]# mkdir -p /etc/kubernetes/manifests</span><br><span class="line">[root@node02 ~]# mkdir /var/lib/kubelet</span><br><span class="line">[root@node02 ~]# mkdir /var/lib/kube-proxy </span><br><span class="line"></span><br><span class="line">[root@node01 ~]# scp -rp kubernetes  node02:/usr/local/</span><br><span class="line">[root@node01 ~]# scp -rp /etc/kubernetes/* node02:/etc/kubernetes/</span><br><span class="line">[root@node01 ~]# scp /var/lib/kubelet/config.yaml  node02:/var/lib/kubelet/</span><br><span class="line">[root@node01 ~]# scp /var/lib/kube-proxy/config.yaml   node02:/var/lib/kube-proxy/</span><br><span class="line">[root@node01 ~]# scp /usr/lib/systemd/system/kube*  node02:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">[root@node02 ~]# echo &quot;export PATH=$PATH:/usr/local/kubernetes/node/bin&quot; &gt; /etc/profile.d/node_path.sh</span><br><span class="line">[root@node02 ~]# source  /etc/profile.d/node_path.sh</span><br></pre></td></tr></table></figure>
<h3 id="配置node03"><a href="#配置node03" class="headerlink" title="配置node03"></a>配置node03</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@node03 ~]# mkdir -p /etc/kubernetes</span><br><span class="line">[root@node03 ~]# mkdir -p /etc/kubernetes/manifests</span><br><span class="line">[root@node03 ~]# mkdir /var/lib/kubelet</span><br><span class="line">[root@node03 ~]# mkdir /var/lib/kube-proxy </span><br><span class="line"></span><br><span class="line">[root@node01 ~]# scp -rp kubernetes  node03:/usr/local/</span><br><span class="line">[root@node01 ~]# scp -rp /etc/kubernetes/* node03:/etc/kubernetes/</span><br><span class="line">[root@node01 ~]# scp /var/lib/kubelet/config.yaml  node03:/var/lib/kubelet/</span><br><span class="line">[root@node01 ~]# scp /var/lib/kube-proxy/config.yaml   node03:/var/lib/kube-proxy/</span><br><span class="line">[root@node01 ~]# scp /usr/lib/systemd/system/kube*  node03:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">[root@node03 ~]# echo &quot;export PATH=$PATH:/usr/local/kubernetes/node/bin&quot; &gt; /etc/profile.d/node_path.sh</span><br><span class="line">[root@node03 ~]# source  /etc/profile.d/node_path.sh</span><br></pre></td></tr></table></figure>
<h3 id="所有节点启动node"><a href="#所有节点启动node" class="headerlink" title="所有节点启动node"></a>所有节点启动node</h3><h4 id="启动kubelet-1"><a href="#启动kubelet-1" class="headerlink" title="启动kubelet"></a>启动kubelet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kubelet.service</span><br><span class="line">systemctl enable kubelet.service</span><br></pre></td></tr></table></figure>
<h4 id="签发证书"><a href="#签发证书" class="headerlink" title="签发证书"></a>签发证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl get csr</span><br><span class="line">NAME        AGE     REQUESTOR             CONDITION</span><br><span class="line">csr-4wdrq   38s     system:bootstrapper   Pending</span><br><span class="line">csr-7dhpt   25s     system:bootstrapper   Pending</span><br><span class="line">csr-nwzz5   73m     system:bootstrapper   Approved,Issued</span><br><span class="line">csr-vl24p   73m     system:bootstrapper   Approved,Issued</span><br><span class="line">csr-xnmjm   66m     system:bootstrapper   Approved,Issued</span><br><span class="line">csr-zc2n9   8m49s   system:bootstrapper   Pending</span><br><span class="line">[root@master01 ~]# kubectl certificate approve csr-4wdrq</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-4wdrq approved</span><br><span class="line">[root@master01 ~]# kubectl certificate approve csr-7dhpt</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-7dhpt approved</span><br><span class="line">[root@master01 ~]# kubectl certificate approve csr-zc2n9</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-zc2n9 approved</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl get node</span><br><span class="line">NAME       STATUS     ROLES    AGE     VERSION</span><br><span class="line">master01   NotReady   &lt;none&gt;   68m     v1.14.2</span><br><span class="line">master02   NotReady   &lt;none&gt;   68m     v1.14.2</span><br><span class="line">master03   NotReady   &lt;none&gt;   68m     v1.14.2</span><br><span class="line">node01     NotReady   &lt;none&gt;   10s     v1.14.2</span><br><span class="line">node02     NotReady   &lt;none&gt;   4m44s   v1.14.2</span><br><span class="line">node03     NotReady   &lt;none&gt;   4m47s   v1.14.2</span><br></pre></td></tr></table></figure>
<h4 id="启动kube-proxy-1"><a href="#启动kube-proxy-1" class="headerlink" title="启动kube-proxy"></a>启动kube-proxy</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> systemctl start kube-proxy.service </span><br><span class="line"> systemctl enable kube-proxy.service</span><br><span class="line"></span><br><span class="line"> ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.96.0.1:443 rr</span><br><span class="line">  -&gt; 192.168.48.101:6443          Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.48.102:6443          Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.48.103:6443          Masq    1      0          0</span><br></pre></td></tr></table></figure>
<h2 id="打上角色标签和污点"><a href="#打上角色标签和污点" class="headerlink" title="打上角色标签和污点"></a>打上角色标签和污点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl label nodes master01 node-role.kubernetes.io/master=&apos;master&apos; </span><br><span class="line">node/master01 labeled</span><br><span class="line">[root@master01 ~]# kubectl label nodes master02 node-role.kubernetes.io/master=&apos;master&apos; </span><br><span class="line">node/master02 labeled</span><br><span class="line">[root@master01 ~]# kubectl label nodes master03 node-role.kubernetes.io/master=&apos;master&apos; </span><br><span class="line">node/master03 labeled</span><br><span class="line">[root@master01 ~]# kubectl label nodes node01 node-role.kubernetes.io/node=&apos;node&apos;</span><br><span class="line">node/node01 labeled</span><br><span class="line">[root@master01 ~]# kubectl label nodes node02 node-role.kubernetes.io/node=&apos;node&apos;</span><br><span class="line">node/node02 labeled</span><br><span class="line">[root@master01 ~]# kubectl label nodes node03 node-role.kubernetes.io/node=&apos;node&apos;</span><br><span class="line">node/node03 labeled</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl get node</span><br><span class="line">NAME       STATUS     ROLES    AGE    VERSION</span><br><span class="line">master01   NotReady   master   122m   v1.14.2</span><br><span class="line">master02   NotReady   master   121m   v1.14.2</span><br><span class="line">master03   NotReady   master   121m   v1.14.2</span><br><span class="line">node01     NotReady   node     53m    v1.14.2</span><br><span class="line">node02     NotReady   node     58m    v1.14.2</span><br><span class="line">node03     NotReady   node     58m    v1.14.2</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl taint nodes master01 node-role.kubernetes.io/master=:NoSchedule</span><br><span class="line">node/master01 tainted</span><br><span class="line">[root@master01 ~]# kubectl taint nodes master02 node-role.kubernetes.io/master=:NoSchedule</span><br><span class="line">node/master02 tainted</span><br><span class="line">[root@master01 ~]# kubectl taint nodes master03 node-role.kubernetes.io/master=:NoSchedule</span><br><span class="line">node/master03 tainted</span><br></pre></td></tr></table></figure>
<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><h3 id="部署flannel"><a href="#部署flannel" class="headerlink" title="部署flannel"></a>部署flannel</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl get node </span><br><span class="line">NAME       STATUS                     ROLES    AGE   VERSION</span><br><span class="line">master01   Ready,SchedulingDisabled   master   27h   v1.14.2</span><br><span class="line">master02   Ready,SchedulingDisabled   master   27h   v1.14.2</span><br><span class="line">master03   Ready,SchedulingDisabled   master   27h   v1.14.2</span><br><span class="line">node01     Ready                      node     26h   v1.14.2</span><br><span class="line">node02     Ready                      node     26h   v1.14.2</span><br><span class="line">node03     Ready                      node     26h   v1.14.2</span><br></pre></td></tr></table></figure>
<h3 id="部署coredns"><a href="#部署coredns" class="headerlink" title="部署coredns"></a>部署coredns</h3><p>准备coredns.yaml文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">vim coredns.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        health</span><br><span class="line">        kubernetes cluster.local 10.96.0.0/12 &#123;</span><br><span class="line">          pods insecure</span><br><span class="line">          upstream</span><br><span class="line">          fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153</span><br><span class="line">        proxy . /etc/resolv.conf</span><br><span class="line">        cache 30</span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">    kubernetes.io/name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      tolerations:</span><br><span class="line">        - key: &quot;CriticalAddonsOnly&quot;</span><br><span class="line">          operator: &quot;Exists&quot;</span><br><span class="line">      nodeSelector:</span><br><span class="line">        beta.kubernetes.io/os: linux</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: coredns/coredns:1.3.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 170Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 70Mi</span><br><span class="line">        args: [ &quot;-conf&quot;, &quot;/etc/coredns/Corefile&quot; ]</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/coredns</span><br><span class="line">          readOnly: true</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9153</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">            drop:</span><br><span class="line">            - all</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      volumes:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: coredns</span><br><span class="line">            items:</span><br><span class="line">            - key: Corefile</span><br><span class="line">              path: Corefile</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/port: &quot;9153&quot;</span><br><span class="line">    prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    kubernetes.io/name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">  clusterIP: 10.96.0.10</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: TCP</span><br><span class="line">  - name: metrics</span><br><span class="line">    port: 9153</span><br><span class="line">    protocol: TCP</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl apply -f coredns.yaml </span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.extensions/coredns created</span><br><span class="line">service/kube-dns created</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-system  -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE    IP               NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-857cdbd8b4-5vtl2      1/1     Running   0          4s     10.244.5.8       node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-857cdbd8b4-65lg7      1/1     Running   0          4s     10.244.3.7       node03     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-2ks98   1/1     Running   2          174m   192.168.48.101   master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-2t4lv   1/1     Running   1          174m   192.168.48.201   node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-2z22w   1/1     Running   1          174m   192.168.48.202   node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-9jzwd   1/1     Running   2          174m   192.168.48.203   node03     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-tl9v2   1/1     Running   2          174m   192.168.48.102   master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-wgmhp   1/1     Running   14         174m   192.168.48.103   master03   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h4 id="验证dns"><a href="#验证dns" class="headerlink" title="验证dns"></a>验证dns</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl run nginx --image=nginx --expose --port=80</span><br><span class="line">[root@master01 ~]# kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP           NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-755464dd6c-gbgj8   1/1     Running   0          2m48s   10.244.4.9   node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">test-55787fcd96-fsz7t    1/1     Running   0          2m1s    10.244.3.8   node03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@master01 ~]# kubectl get svc -o wide</span><br><span class="line">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP   24h   &lt;none&gt;</span><br><span class="line">nginx        ClusterIP   10.96.106.92   &lt;none&gt;        80/TCP    3m    run=nginx</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl run test --rm -it --image=alpine /bin/sh</span><br><span class="line">/ # cat /etc/resolv.conf </span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br><span class="line">/ # nslookup nginx.default.svc.cluster.local</span><br><span class="line">nslookup: can&apos;t resolve &apos;(null)&apos;: Name does not resolve</span><br><span class="line"></span><br><span class="line">Name:      nginx.default.svc.cluster.local</span><br><span class="line">Address 1: 10.96.106.92 nginx.default.svc.cluster.local</span><br><span class="line">/ # ping nginx.default.svc.cluster.local</span><br><span class="line">PING nginx.default.svc.cluster.local (10.96.106.92): 56 data bytes</span><br><span class="line">64 bytes from 10.96.106.92: seq=0 ttl=64 time=0.063 ms</span><br><span class="line">64 bytes from 10.96.106.92: seq=1 ttl=64 time=0.141 ms</span><br><span class="line">64 bytes from 10.96.106.92: seq=2 ttl=64 time=0.121 ms</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>Donate me, big brother</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="TangWei WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="TangWei Alipay">
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Kubernetes/" rel="tag"> <i class="fa fa-tag"></i> Kubernetes</a>
          
            <a href="/tags/Bin/" rel="tag"> <i class="fa fa-tag"></i> Bin</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/15/30.Grafana Install/" rel="next" title="30.Grafana Install">
                <i class="fa fa-chevron-left"></i> 30.Grafana Install
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/me.png" alt="TangWei">
            
              <p class="site-author-name" itemprop="name">TangWei</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">43</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/tangwei0928" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/5304895321" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" title="Kubernetes" target="_blank">Kubernetes</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#二进制安装k8s-v1-14-2"><span class="nav-number">1.</span> <span class="nav-text">二进制安装k8s v1.14.2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#环境准备"><span class="nav-number">1.1.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#所有节点执行"><span class="nav-number">1.2.</span> <span class="nav-text">所有节点执行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#所有节点关闭selinux和firewalld"><span class="nav-number">1.2.1.</span> <span class="nav-text">所有节点关闭selinux和firewalld</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有节点升级内核"><span class="nav-number">1.2.2.</span> <span class="nav-text">所有节点升级内核</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#从3-10-升级到-4-4-180"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">从3.10 升级到 4.4.180</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置grub2"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">设置grub2</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有节点关闭swap"><span class="nav-number">1.2.3.</span> <span class="nav-text">所有节点关闭swap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有节点开启内核转发参数"><span class="nav-number">1.2.4.</span> <span class="nav-text">所有节点开启内核转发参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有节点开启IPVS"><span class="nav-number">1.2.5.</span> <span class="nav-text">所有节点开启IPVS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有节点安装docker"><span class="nav-number">1.2.6.</span> <span class="nav-text">所有节点安装docker</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#启动docker"><span class="nav-number">1.2.6.1.</span> <span class="nav-text">启动docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取pause-3-1"><span class="nav-number">1.2.6.2.</span> <span class="nav-text">获取pause:3.1</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有节点安装CNI"><span class="nav-number">1.2.7.</span> <span class="nav-text">所有节点安装CNI</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd安装"><span class="nav-number">1.3.</span> <span class="nav-text">etcd安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#etcd节点"><span class="nav-number">1.3.1.</span> <span class="nav-text">etcd节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etcd所有节点安装etcd"><span class="nav-number">1.3.2.</span> <span class="nav-text">etcd所有节点安装etcd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备证书脚本"><span class="nav-number">1.3.3.</span> <span class="nav-text">准备证书脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建etcd的证书"><span class="nav-number">1.3.4.</span> <span class="nav-text">创建etcd的证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置etcd01"><span class="nav-number">1.3.5.</span> <span class="nav-text">配置etcd01</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置etcd02"><span class="nav-number">1.3.6.</span> <span class="nav-text">配置etcd02</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置etcd03"><span class="nav-number">1.3.7.</span> <span class="nav-text">配置etcd03</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动etcd集群"><span class="nav-number">1.3.8.</span> <span class="nav-text">启动etcd集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证etcd集群"><span class="nav-number">1.3.9.</span> <span class="nav-text">验证etcd集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HA部署"><span class="nav-number">1.4.</span> <span class="nav-text">HA部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HA节点"><span class="nav-number">1.4.1.</span> <span class="nav-text">HA节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装haproxy和keepalived"><span class="nav-number">1.4.2.</span> <span class="nav-text">安装haproxy和keepalived</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置keepalived"><span class="nav-number">1.4.3.</span> <span class="nav-text">配置keepalived</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#master01-keepalived"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">master01 keepalived</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#master02-keepalived"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">master02 keepalived</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#master03-keepalived"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">master03 keepalived</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动服务"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">启动服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置haproxy"><span class="nav-number">1.4.4.</span> <span class="nav-text">配置haproxy</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#所有haproxy都一样"><span class="nav-number">1.4.4.1.</span> <span class="nav-text">所有haproxy都一样</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动服务-1"><span class="nav-number">1.4.4.2.</span> <span class="nav-text">启动服务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#master-部署"><span class="nav-number">1.5.</span> <span class="nav-text">master 部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#master节点"><span class="nav-number">1.5.1.</span> <span class="nav-text">master节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建k8s证书"><span class="nav-number">1.5.2.</span> <span class="nav-text">创建k8s证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有master节点下载server端二进制包"><span class="nav-number">1.5.3.</span> <span class="nav-text">所有master节点下载server端二进制包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置master01"><span class="nav-number">1.5.4.</span> <span class="nav-text">配置master01</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#编辑-etc-kubernetes-中配置文件"><span class="nav-number">1.5.4.1.</span> <span class="nav-text">编辑/etc/kubernetes/中配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kubelet"><span class="nav-number">1.5.4.1.1.</span> <span class="nav-text">编辑kubelet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑apiserver"><span class="nav-number">1.5.4.1.2.</span> <span class="nav-text">编辑apiserver</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑config"><span class="nav-number">1.5.4.1.3.</span> <span class="nav-text">编辑config</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑controller-manager"><span class="nav-number">1.5.4.1.4.</span> <span class="nav-text">编辑controller-manager</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑scheduler"><span class="nav-number">1.5.4.1.5.</span> <span class="nav-text">编辑scheduler</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑proxy"><span class="nav-number">1.5.4.1.6.</span> <span class="nav-text">编辑proxy</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编辑-usr-lib-systemed-system-中启动文件"><span class="nav-number">1.5.4.2.</span> <span class="nav-text">编辑/usr/lib/systemed/system/中启动文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kube-apiserver-service"><span class="nav-number">1.5.4.2.1.</span> <span class="nav-text">编辑kube-apiserver.service</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kube-controller-manager-service"><span class="nav-number">1.5.4.2.2.</span> <span class="nav-text">编辑kube-controller-manager.service</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kube-scheduler-service"><span class="nav-number">1.5.4.2.3.</span> <span class="nav-text">编辑kube-scheduler.service</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kubelet-service"><span class="nav-number">1.5.4.2.4.</span> <span class="nav-text">编辑kubelet.service</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kube-proxy-service"><span class="nav-number">1.5.4.2.5.</span> <span class="nav-text">编辑kube-proxy.service</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编辑-var-lib中config-yaml文件"><span class="nav-number">1.5.4.3.</span> <span class="nav-text">编辑/var/lib中config.yaml文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kubelet的config-yaml"><span class="nav-number">1.5.4.3.1.</span> <span class="nav-text">编辑kubelet的config.yaml</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kube-proxy的config-yaml"><span class="nav-number">1.5.4.3.2.</span> <span class="nav-text">编辑kube-proxy的config.yaml</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置master02"><span class="nav-number">1.5.5.</span> <span class="nav-text">配置master02</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置master03"><span class="nav-number">1.5.6.</span> <span class="nav-text">配置master03</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有master节点启动master集群"><span class="nav-number">1.5.7.</span> <span class="nav-text">所有master节点启动master集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#启动apiserver"><span class="nav-number">1.5.7.1.</span> <span class="nav-text">启动apiserver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置kubectl"><span class="nav-number">1.5.7.2.</span> <span class="nav-text">配置kubectl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kubectl自动补全"><span class="nav-number">1.5.7.3.</span> <span class="nav-text">kubectl自动补全</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建clusterrolebinding-绑定bootstapper"><span class="nav-number">1.5.7.4.</span> <span class="nav-text">创建clusterrolebinding  绑定bootstapper</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动kube-controller-manager-service"><span class="nav-number">1.5.7.5.</span> <span class="nav-text">启动kube-controller-manager.service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动kube-scheduler-service"><span class="nav-number">1.5.7.6.</span> <span class="nav-text">启动kube-scheduler.service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查master是否成功启动"><span class="nav-number">1.5.7.7.</span> <span class="nav-text">检查master是否成功启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动kubelet"><span class="nav-number">1.5.7.8.</span> <span class="nav-text">启动kubelet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动kube-proxy"><span class="nav-number">1.5.7.9.</span> <span class="nav-text">启动kube-proxy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#签发master证书"><span class="nav-number">1.5.7.10.</span> <span class="nav-text">签发master证书</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#node部署"><span class="nav-number">1.6.</span> <span class="nav-text">node部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#node节点"><span class="nav-number">1.6.1.</span> <span class="nav-text">node节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有node节点下载node二进制包"><span class="nav-number">1.6.2.</span> <span class="nav-text">所有node节点下载node二进制包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置node01"><span class="nav-number">1.6.3.</span> <span class="nav-text">配置node01</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#编辑-etc-kubernetes-中配置文件-1"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">编辑/etc/kubernetes/中配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kubelet-1"><span class="nav-number">1.6.3.1.1.</span> <span class="nav-text">编辑kubelet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑config-1"><span class="nav-number">1.6.3.1.2.</span> <span class="nav-text">编辑config</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑proxy-1"><span class="nav-number">1.6.3.1.3.</span> <span class="nav-text">编辑proxy</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编辑-usr-lib-systemed-system-中启动文件-1"><span class="nav-number">1.6.3.2.</span> <span class="nav-text">编辑/usr/lib/systemed/system/中启动文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kubelet-service-1"><span class="nav-number">1.6.3.2.1.</span> <span class="nav-text">编辑kubelet.service</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kube-proxy-service-1"><span class="nav-number">1.6.3.2.2.</span> <span class="nav-text">编辑kube-proxy.service</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编辑-var-lib中config-yaml文件-1"><span class="nav-number">1.6.3.3.</span> <span class="nav-text">编辑/var/lib中config.yaml文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kubelet的config-yaml-1"><span class="nav-number">1.6.3.3.1.</span> <span class="nav-text">编辑kubelet的config.yaml</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑kube-proxy的config-yaml-1"><span class="nav-number">1.6.3.3.2.</span> <span class="nav-text">编辑kube-proxy的config.yaml</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置node02"><span class="nav-number">1.6.4.</span> <span class="nav-text">配置node02</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置node03"><span class="nav-number">1.6.5.</span> <span class="nav-text">配置node03</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有节点启动node"><span class="nav-number">1.6.6.</span> <span class="nav-text">所有节点启动node</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#启动kubelet-1"><span class="nav-number">1.6.6.1.</span> <span class="nav-text">启动kubelet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#签发证书"><span class="nav-number">1.6.6.2.</span> <span class="nav-text">签发证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动kube-proxy-1"><span class="nav-number">1.6.6.3.</span> <span class="nav-text">启动kube-proxy</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#打上角色标签和污点"><span class="nav-number">1.7.</span> <span class="nav-text">打上角色标签和污点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络"><span class="nav-number">1.8.</span> <span class="nav-text">网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部署flannel"><span class="nav-number">1.8.1.</span> <span class="nav-text">部署flannel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署coredns"><span class="nav-number">1.8.2.</span> <span class="nav-text">部署coredns</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#验证dns"><span class="nav-number">1.8.2.1.</span> <span class="nav-text">验证dns</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">TangWei</span>

  
</div>

<!--
  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>
 -->



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>